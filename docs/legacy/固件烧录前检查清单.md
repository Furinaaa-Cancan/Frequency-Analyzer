# 🔍 固件烧录前完整检查清单

## ✅ 代码集成状态

### 已完成的修改
- ✅ **LED驱动替换** (`firmware/BSP/LED/led.c`, `led.h`)
- ✅ **TIMER驱动添加** (`firmware/BSP/TIMER_LED/timer_led.c`, `timer_led.h`)
- ✅ **主程序修改** (`firmware/USER/main.c`)
- ✅ **串口命令扩展** (`firmware/BSP/USART/usart.c`)

---

## ⚠️ **重要！手动操作要求**

### 🔴 必须在Keil中手动添加文件

**文件**: `firmware/BSP/TIMER_LED/timer_led.c`

**操作步骤**:
```
1. 打开 Keil 工程: Tamlate.uvprojx
2. 在 Project 窗口中找到 BSP 组
3. 右键 BSP 组
4. 选择: Add Existing Files to Group 'BSP'
5. 浏览到: firmware/BSP/TIMER_LED/timer_led.c
6. 点击 Add
7. 点击 Close
```

**❌ 如果不添加此文件，会导致**:
- 编译错误: `undefined reference to 'TIM1_Init_LED'`
- 链接失败

---

## 📋 编译前检查清单

### 1. 文件存在性检查

```bash
✅ firmware/BSP/LED/led.h (83行)
✅ firmware/BSP/LED/led.c (533行)
✅ firmware/BSP/TIMER_LED/timer_led.h (15行)
✅ firmware/BSP/TIMER_LED/timer_led.c (115行)
✅ firmware/USER/main.c (已修改，包含LED初始化)
✅ firmware/BSP/USART/usart.c (已修改，包含LED命令)
```

### 2. 头文件包含检查

**main.c 应包含**:
```c
#include "main.h"
#include "led.h"
#include "timer.h"
#include "timer_led.h"  /* ✅ LED PWM定时器 */
#include "usart.h"
```

### 3. 初始化顺序检查

**main.c 中的初始化应包含**:
```c
/* 10. 初始化LED控制系统（集成自作业4）*/
LED_Init();
printf("[OK] LED system initialized (GPIOB: PB11-PB15).\r\n");

/* 11. 初始化TIMER1（20kHz中断用于LED PWM）*/
TIM1_Init_LED(71, 49);  /* 72MHz/(71+1)/(49+1) = 20kHz */
printf("[OK] TIMER1 initialized (20kHz for LED PWM).\r\n");

/* 12. 设置默认LED状态为OFF */
LED_Set_Mode(LED_MODE_OFF);
printf("[INFO] LED mode: OFF (default).\r\n");
```

### 4. GPIO引脚定义检查

**led.h 中的引脚定义**:
```c
LED3: GPIOB, GPIO_PIN_11
LED7: GPIOB, GPIO_PIN_12
LED4: GPIOB, GPIO_PIN_13
LED6: GPIOB, GPIO_PIN_14
LED5: GPIOB, GPIO_PIN_15
```

**⚠️ 确认这些引脚未被其他功能占用！**

---

## 🔧 Keil工程配置检查

### 1. 文件添加确认

在 Keil Project 窗口中应看到:
```
├── BSP/
│   ├── led.c                    ✅
│   ├── timer_led.c              ⚠️ 需手动添加！
│   ├── usart.c                  ✅
│   ├── adc.c                    ✅
│   ├── (其他文件...)
```

### 2. 包含路径确认

Keil 项目设置 → C/C++ → Include Paths 应包含:
```
firmware/BSP/LED
firmware/BSP/TIMER_LED
firmware/BSP/USART
(其他路径...)
```

### 3. 编译选项

- ✅ 优化级别: -O0 或 -O1（调试用）
- ✅ C99 模式
- ✅ 使用 microLIB（如果之前使用）

---

## 🧪 编译测试流程

### 步骤1: 清理工程
```
Keil → Project → Clean Targets
```

### 步骤2: 编译工程
```
按 F7 或 Project → Build Target
```

### 步骤3: 检查输出
期望结果:
```
Build target 'Template'
compiling led.c...
compiling timer_led.c...          ← 应该看到这一行！
compiling main.c...
compiling usart.c...
...
linking...
creating hex file...

✅ 0 Error(s)
✅ 0 Warning(s)
```

### ❌ 如果出现错误

**错误1**: `undefined reference to 'TIM1_Init_LED'`
- **原因**: timer_led.c 未添加到工程
- **解决**: 按上面步骤手动添加

**错误2**: `cannot open source input file "timer_led.h"`
- **原因**: 包含路径未配置
- **解决**: 添加 `firmware/BSP/TIMER_LED` 到 Include Paths

**错误3**: `multiple definition of 'TIMER1_IRQHandler'`
- **原因**: 有多个文件定义了同一个中断
- **解决**: 确认只有 timer_led.c 中有 TIMER1_IRQHandler

---

## 🔥 下载烧录流程

### 步骤1: 连接硬件
```
1. 连接 ST-Link 或 J-Link 调试器
2. 连接开发板电源
3. 确认连接指示灯亮起
```

### 步骤2: 配置下载选项
```
Keil → Options for Target → Debug
- 选择调试器类型 (CMSIS-DAP/ST-Link/J-Link)
- 点击 Settings 确认连接正常
```

### 步骤3: 下载程序
```
按 F8 或 Flash → Download
```

### 步骤4: 确认下载成功
```
应显示:
Programming...
Erasing...
Programming...
Verify OK

✅ Download successful!
```

---

## 🧪 功能测试流程

### 1. 串口连接
```
波特率: 115200
数据位: 8
停止位: 1
校验: None
```

### 2. 基础测试

**测试1: 启动信息**
```
复位开发板后应看到:
[OK] LED system initialized (GPIOB: PB11-PB15).
[OK] TIMER1 initialized (20kHz for LED PWM).
[INFO] LED mode: OFF (default).
```

**测试2: 帮助命令**
```
发送: HELP
应显示包含:
  LED Commands:
    LED:0-6        - Set LED mode
    LED_BRIGHT:50  - Set brightness (0-100%)
    LED_FREQ:500   - Set interval (1-30000ms)
```

**测试3: LED模式**
```
发送: LED:1
期望: LED 显示流水灯效果
回复: OK:LED_MODE:Flow

发送: LED:2
期望: LED 显示呼吸灯效果
回复: OK:LED_MODE:Breath
```

**测试4: 亮度控制**
```
发送: LED_BRIGHT:50
期望: LED 亮度降低到 50%
回复: OK:LED_BRIGHTNESS:50%
```

**测试5: 间隔控制**
```
发送: LED_FREQ:500
期望: LED 闪烁速度加快
回复: OK:LED_INTERVAL:500ms
```

**测试6: 报警模式**
```
发送: LED:6
期望: 所有 LED 以 2Hz 快速闪烁，最大亮度
回复: OK:LED_MODE:Alarm
```

**测试7: 关闭LED**
```
发送: LED:0
期望: 所有 LED 关闭
回复: OK:LED_MODE:OFF
```

---

## 🔍 故障排查

### 问题1: LED不亮

**可能原因**:
1. ❌ GPIO 引脚定义错误
2. ❌ LED 未初始化
3. ❌ TIMER1 未启动
4. ❌ 硬件连接问题

**排查步骤**:
```c
// 1. 测试单个LED直接控制
LED3_H;  // LED3 应该亮
delay_ms(1000);
LED3_L;  // LED3 应该灭

// 2. 检查初始化是否执行
// 查看串口输出是否有:
// [OK] LED system initialized
// [OK] TIMER1 initialized

// 3. 测试命令响应
发送: LED:3
发送: LED_BRIGHT:100
```

### 问题2: LED闪烁不规律

**可能原因**:
1. ❌ TIMER1 中断未正常工作
2. ❌ 中断优先级冲突

**排查步骤**:
```c
// 在 TIMER1_IRQHandler 中添加测试代码:
void TIMER1_IRQHandler(void) {
    static uint32_t count = 0;
    count++;
    if(count % 20000 == 0) {  // 每秒
        printf("TIMER1 running: %ld\r\n", count);
    }
    LED_Process();
}
```

### 问题3: 串口命令无响应

**可能原因**:
1. ❌ usart.c 未正确修改
2. ❌ 命令格式错误

**排查步骤**:
```
// 发送其他命令测试 USART 是否正常
发送: HELP
发送: SWEEP

// 确认命令格式正确（无空格）
✅ LED:1
❌ LED: 1
❌ led:1
```

### 问题4: 编译警告

**常见警告**:
```
Warning: unused variable 'xxx'
→ 可忽略，不影响功能

Warning: implicit declaration of function 'xxx'
→ 需要检查头文件包含
```

---

## 📊 性能指标

### TIMER配置
| TIMER | 频率 | 用途 | 优先级 |
|-------|------|------|--------|
| TIMER1 | 20KHz | LED PWM | 1,1 (中) |
| TIMER2 | 50KHz | DDS | 0,0 (高) |
| TIMER3 | 20KHz | ADC触发 | 2,0 (低) |

### CPU占用估算
- LED处理: ~2% (TIMER1中断)
- DDS生成: ~10% (TIMER2中断)
- ADC采样: ~5% (TIMER3 + DMA)
- **总计**: ~17% (有大量余量)

### 内存使用
- LED驱动: ~500 bytes (代码)
- LED状态: ~50 bytes (RAM)
- TIMER_LED: ~200 bytes (代码)
- **总计**: ~750 bytes (Flash + RAM)

---

## ✅ 最终确认清单

### 代码层面
- [ ] timer_led.c 已添加到 Keil 工程
- [ ] main.c 包含 #include "timer_led.h"
- [ ] main.c 中有 LED_Init() 调用
- [ ] main.c 中有 TIM1_Init_LED() 调用
- [ ] usart.c 包含 LED 命令处理
- [ ] 编译 0 Errors, 0 Warnings

### 硬件层面
- [ ] 开发板供电正常
- [ ] 调试器连接正常
- [ ] LED 硬件正常（PB11-PB15）
- [ ] 串口连接正常（PA9/PA10）

### 功能层面
- [ ] 能够下载程序
- [ ] 串口有启动信息
- [ ] HELP 命令显示 LED 帮助
- [ ] LED:1 命令有效果
- [ ] LED_BRIGHT 命令有效果
- [ ] LED_FREQ 命令有效果
- [ ] LED:6 报警模式正常

---

## 🎯 烧录成功标志

**如果看到以下现象，说明集成成功**:

1. ✅ 编译无错误
2. ✅ 下载成功
3. ✅ 串口输出启动信息
4. ✅ LED 默认全灭
5. ✅ 发送 LED:1 后 LED 流水
6. ✅ 发送 LED:6 后 LED 快闪
7. ✅ 原有 Bode 测量功能正常

**🎉 恭喜！固件集成完成！**

---

## 📞 紧急联系

如果遇到无法解决的问题:

1. **检查备份**: `firmware_backup_YYYYMMDD_HHMMSS/`
2. **查看文档**: `LED集成完成说明.md`
3. **重新集成**: 从备份恢复后重新按步骤集成

---

**最后更新**: 2025-11-25  
**版本**: v1.0  
**状态**: Ready for Flash ✅
