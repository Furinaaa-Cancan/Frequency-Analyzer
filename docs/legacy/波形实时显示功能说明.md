# 波形实时显示功能说明

## 📊 功能概述

现在系统支持在Web界面实时显示输入和输出正弦波信号，让您可以直观地观察被测电路的时域响应。

## ✨ 新增功能

### 1. 固件端改进

#### ProcessADCData函数（单频测试）
- 在执行 `MEASURE` 命令时，自动发送完整波形数据
- 发送64个采样点（从512个采样点中每8个取1个）
- 同时显示输入信号（PA6）和输出信号（PB1）

#### AutoSweep函数（扫频测试）
- 在扫频过程中，每隔100Hz发送一次波形数据
- 波形发送频率点：100Hz, 200Hz, 300Hz, ..., 1000Hz
- 减少数据传输量，避免串口拥塞

### 2. Web界面改进

#### 新增波形显示组件
- 使用Chart.js实时绘制波形
- 蓝色曲线：输入信号 K·sin(ωt)
- 红色曲线：输出信号 K₁·sin(ωt + θ)
- 自动计算并显示信号统计信息：
  - 峰峰值（ADC原始值）
  - 最大/最小值
  - 幅值比 H = K₁/K

## 📡 数据格式

### 波形数据格式
```
WAVEFORM:freq,sampleRate,input_data|output_data
```

**示例：**
```
WAVEFORM:100,10000,2048,2156,2264,...|1856,1934,2012,...
```

**参数说明：**
- `freq`: 测试频率（Hz）
- `sampleRate`: 采样率（固定10000Hz）
- `input_data`: 输入信号ADC采样值序列（用逗号分隔）
- `output_data`: 输出信号ADC采样值序列（用逗号分隔）
- 分隔符：使用 `|` 分隔输入和输出数据

## 🎯 使用方法

### 方法1：单频测试
1. 连接串口
2. 设置测试频率：`FREQ:100`
3. 执行测量：`MEASURE`
4. Web界面会自动显示该频率的输入/输出波形

### 方法2：扫频测试
1. 连接串口
2. 执行扫频：`SWEEP`
3. Web界面会在以下频率点更新波形：
   - 100Hz, 200Hz, 300Hz, ..., 1000Hz
4. 波形显示区会实时更新为最新测量的波形

## 📊 界面说明

### 波形显示区位置
- 位于"公式说明"之后、"Bode图"之前
- 当没有波形数据时显示提示信息
- 有数据时显示完整波形图表

### 显示信息
1. **波形图表**
   - X轴：时间（毫秒）
   - Y轴：ADC值（0-4095）
   - 支持缩放和平移查看细节

2. **测试参数**
   - 测试频率
   - 采样率
   - 采样点数

3. **信号统计**
   - 输入信号：峰峰值、最大值、最小值
   - 输出信号：峰峰值、最大值、最小值
   - 幅值比：H = K₁/K（输出/输入）

## 🔧 技术细节

### 数据采样
- 原始采样：512个点 @ 10kHz采样率
- 传输采样：64个点（每8个取1个）
- 传输数据量：约130字节/波形

### 数据处理流程
```
固件采集 → 串口传输 → React解析 → Chart.js渲染
  512点      64点       数组对象      可视化图表
```

### 性能优化
1. **固件端：**
   - 采样率降低：只传输64个采样点
   - 选择性发送：扫频时只在关键频率点发送

2. **前端：**
   - 实时更新：收到新数据立即更新
   - 图表复用：不销毁Chart对象，只更新数据
   - 动画优化：减少动画时间（300ms）

## 📈 应用场景

### 1. 信号质量检查
- 观察信号是否失真
- 检查是否有削波（clipping）
- 验证ADC采样是否正常

### 2. 相位关系观察
- 直观看到输入/输出的相位差
- 验证相位计算的准确性
- 观察不同频率下的相位变化

### 3. 幅度关系观察
- 比较输入/输出信号幅度
- 验证增益计算
- 发现异常的增益变化

### 4. 故障诊断
- 信号丢失：波形平坦
- 连接错误：波形异常
- 噪声问题：波形抖动

## ⚠️ 注意事项

1. **数据量控制**
   - 扫频时不是每个频率点都发送波形
   - 只在100Hz的倍数频率发送
   - 避免串口数据拥塞

2. **实时性**
   - 波形显示有轻微延迟（<1秒）
   - 适合观察稳态信号
   - 不适合快速变化信号

3. **采样限制**
   - 只显示最近一次测量的波形
   - 不保存历史波形
   - 如需保存，请截图

## 🎓 理论基础

### 时域 vs 频域
- **波形显示（时域）**: 观察信号随时间的变化
- **Bode图（频域）**: 观察系统随频率的特性

### 为什么需要波形显示？
1. **验证信号质量**: Bode图看不出信号失真
2. **直观理解相位**: 波形显示比相位角度更直观
3. **故障诊断**: 异常波形比异常数值更容易发现
4. **教学演示**: 时域和频域对比，加深理解

## 📝 示例输出

### 终端输出（固件）
```
========================================
Mode: External Feedback Monitoring
Frequency: 100 Hz
CH1 (PA6): 1.65 mV Vpp, ADC=2048, DC=2048
CH2 (PB1): 1.32 mV Vpp, ADC=1638, DC=2048
Gain H(w): 0.8000 x (-1.94 dB)
Phase theta(w): -45.23 deg
========================================
FREQ_RESP:100,1.65,1.32,0.8000,-45.23
WAVEFORM:100,10000,2048,2156,2264,2364,...|2048,2012,1934,1856,...
```

### Web界面显示
- 📊 实时信号波形图表
- 📍 测试频率: 100 Hz
- 📊 采样率: 10 kHz
- 📊 采样点数: 64

输入信号统计：
- 峰峰值: 2048
- 最大: 3072
- 最小: 1024

输出信号统计：
- 峰峰值: 1638
- 最大: 2867
- 最小: 1229

幅值比: H = 0.8000

## 🚀 未来扩展

### 可能的改进方向
1. **FFT频谱分析**: 显示信号频谱
2. **相位差标注**: 在波形上标注相位差
3. **历史波形对比**: 保存多个频率波形对比
4. **波形录制**: 导出波形数据为CSV
5. **触发功能**: 支持特定条件触发波形捕获

## 📞 技术支持

如有问题，请检查：
1. 串口连接是否正常
2. 固件是否正确烧录
3. Web应用是否正确启动
4. 浏览器控制台是否有错误信息

---

**版本**: v5.0 + 波形显示功能
**更新日期**: 2025-11-02
**作者**: Bode Plot Analyzer Team








