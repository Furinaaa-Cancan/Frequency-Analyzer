# è®¡ç®—æµç¨‹ä¸¥æ ¼å®¡æŸ¥

## ğŸ“Š å®Œæ•´æ•°æ®æµ

### 1ï¸âƒ£ ADCæ•°æ®æå–

```c
void ExtractADCData(uint16_t *adc0_data, uint16_t *adc1_data, uint32_t count)
{
    adc0_data[i] = (adc_buffer[i] & 0xFFFF);        // ä½16ä½ = ADC0
    adc1_data[i] = ((adc_buffer[i] >> 16) & 0xFFFF); // é«˜16ä½ = ADC1
}
```

**GD32åŒADCæ¨¡å¼å¯„å­˜å™¨æ ¼å¼**ï¼š
```
ADC_RDATA[31:16] = ADC1æ•°æ® (PB1 / ADC1_CH9)
ADC_RDATA[15:0]  = ADC0æ•°æ® (PA6 / ADC0_CH6)
```

**ç¡¬ä»¶é…ç½®**ï¼š
```c
ADC0: PA6 (GPIO_PIN_6) â†’ ADC_CHANNEL_6
ADC1: PB1 (GPIO_PIN_1) â†’ ADC_CHANNEL_9
```

**ç»“è®º**ï¼š
- âœ… `adc0_data[]` = PA6çš„é‡‡æ ·å€¼
- âœ… `adc1_data[]` = PB1çš„é‡‡æ ·å€¼

---

### 2ï¸âƒ£ å³°å³°å€¼è®¡ç®—

```c
pp_ch1 = CalculatePeakToPeak(adc0_data, 512);  // PA6å³°å³°å€¼
pp_ch2 = CalculatePeakToPeak(adc1_data, 512);  // PB1å³°å³°å€¼
```

**CalculatePeakToPeakå‡½æ•°**ï¼š
```c
uint16_t CalculatePeakToPeak(uint16_t *data, uint32_t count)
{
    uint16_t min = 4095, max = 0;
    for(i = 0; i < count; i++) {
        if(data[i] < min) min = data[i];
        if(data[i] > max) max = data[i];
    }
    return (max - min);  // âœ… æ­£ç¡®ï¼šå³°å³°å€¼ = æœ€å¤§å€¼ - æœ€å°å€¼
}
```

**ç»“è®º**ï¼š
- âœ… `pp_ch1` = PA6çš„å³°å³°å€¼ (ADCåŸå§‹å€¼, 0-4095)
- âœ… `pp_ch2` = PB1çš„å³°å³°å€¼ (ADCåŸå§‹å€¼, 0-4095)

---

### 3ï¸âƒ£ ç”µå‹è½¬æ¢

```c
float voltage_ch1 = ((float)pp_ch1 * 3.3f) / 4096.0f;  // PA6ç”µå‹
float voltage_ch2 = ((float)pp_ch2 * 3.3f) / 4096.0f;  // PB1ç”µå‹
```

**å…¬å¼éªŒè¯**ï¼š
```
V = (ADC_value / 4096) Ã— 3.3V
```

**ç¤ºä¾‹**ï¼š
```
pp_ch1 = 256 â†’ voltage_ch1 = (256 * 3.3) / 4096 = 0.2063V âœ…
pp_ch2 = 491 â†’ voltage_ch2 = (491 * 3.3) / 4096 = 0.3954V âœ…
```

**ç»“è®º**ï¼š
- âœ… `voltage_ch1` = PA6ç”µå‹ (V, æµ®ç‚¹æ•°)
- âœ… `voltage_ch2` = PB1ç”µå‹ (V, æµ®ç‚¹æ•°)

---

### 4ï¸âƒ£ H(Ï‰)è®¡ç®—

```c
float H = 0.0f;
if(voltage_ch1 > 0.001f) {
    H = voltage_ch2 / voltage_ch1;
}
```

**ç‰©ç†æ„ä¹‰**ï¼š
```
H(Ï‰) = Kâ‚/K = è¾“å‡º/è¾“å…¥ = PB1/PA6
```

**â“ å…³é”®é—®é¢˜ï¼šPA6å’ŒPB1è°æ˜¯"è¾“å…¥"è°æ˜¯"è¾“å‡º"ï¼Ÿ**

**ä»ç”µè·¯å›¾çœ‹**ï¼š
```
DAC5311 â†’ U1A â†’ PA6 â†’ [U1B+U1C] â†’ PB1
```

**ä¸¤ç§ç†è§£**ï¼š

#### ç†è§£Aï¼šPA6æ˜¯è¾“å…¥ï¼ŒPB1æ˜¯è¾“å‡º
```
è¾“å…¥ï¼šPA6 (ä¸­é—´çº§ä¿¡å·)
è¾“å‡ºï¼šPB1 (æœ€ç»ˆè¾“å‡º)
H(Ï‰) = PB1/PA6 = voltage_ch2/voltage_ch1 âœ… ä»£ç æ­£ç¡®
```

#### ç†è§£Bï¼šPB1æ˜¯è¾“å…¥ï¼ŒPA6æ˜¯è¾“å‡ºï¼Ÿï¼Ÿ
```
è¿™ä¸åˆç†ï¼å› ä¸ºä¿¡å·æµå‘æ˜¯ PA6 â†’ PB1
```

**ç»“è®º**ï¼š
- âœ… å½“å‰ä»£ç  `H = voltage_ch2 / voltage_ch1` æ˜¯æ­£ç¡®çš„
- âœ… H(Ï‰) = PB1/PA6 ç¬¦åˆç”µè·¯é€»è¾‘

---

### 5ï¸âƒ£ ç›¸ä½è®¡ç®—

```c
int32_t phase_raw = EstimatePhaseShift_Int(adc0_data, adc1_data, 512, 10000, freq);
```

**EstimatePhaseShift_Intå‡½æ•°**ï¼š
```c
int32_t EstimatePhaseShift_Int(uint16_t *signal1, uint16_t *signal2, ...)
{
    // signal1 = adc0_data = PA6
    // signal2 = adc1_data = PB1
    
    float phase1_rad = atan2f(sin_sum1, cos_sum1);  // PA6ç›¸ä½
    float phase2_rad = atan2f(sin_sum2, cos_sum2);  // PB1ç›¸ä½
    
    float phase_diff_rad = phase1_rad - phase2_rad;  // PA6 - PB1
    
    return (int32_t)(phase_diff_deg * 100);  // è¿”å›ï¼šåº¦Ã—100
}
```

**â“ å…³é”®é—®é¢˜ï¼šç›¸ä½å·®å®šä¹‰**

**å½“å‰ä»£ç **ï¼š
```
Î¸ = PA6 - PB1 = è¾“å…¥ - è¾“å‡º
```

**æ ‡å‡†Bodeå›¾å®šä¹‰**ï¼š
```
Î¸(Ï‰) = è¾“å‡ºç›¸ä½ - è¾“å…¥ç›¸ä½ = PB1 - PA6
```

**âŒ å‘ç°é—®é¢˜ï¼ç›¸ä½å·®å®šä¹‰åäº†ï¼**

**åº”è¯¥æ˜¯**ï¼š
```c
float phase_diff_rad = phase2_rad - phase1_rad;  // PB1 - PA6 = è¾“å‡º - è¾“å…¥
```

---

### 6ï¸âƒ£ è¾“å‡ºæ ¼å¼

```c
printf("FREQ_RESP:%d,%.4f,%.4f,%.6f,%s%.2f\r\n", 
       freq,
       voltage_ch1, voltage_ch2,  // K, Kâ‚
       H,                          // H(Ï‰)
       (phase_unwrapped<0)?"-":"", (float)abs(phase_unwrapped)/100.0f  // Î¸(Ï‰)
);
```

**è¾“å‡ºé¡ºåº**ï¼š
```
FREQ_RESP:freq,K,Kâ‚,H,Î¸
         = freq,PA6,PB1,PB1/PA6,Î¸
```

---

## ğŸš¨ å‘ç°çš„é—®é¢˜

### âŒ **é—®é¢˜1ï¼šç›¸ä½å·®ç¬¦å·é”™è¯¯**

**å½“å‰ä»£ç **ï¼š
```c
phase_diff_rad = phase1_rad - phase2_rad;  // PA6 - PB1
```

**åº”è¯¥æ”¹ä¸º**ï¼š
```c
phase_diff_rad = phase2_rad - phase1_rad;  // PB1 - PA6
```

**åŸå› **ï¼š
- æ ‡å‡†Bodeå›¾å®šä¹‰ï¼šÎ¸ = è¾“å‡ºç›¸ä½ - è¾“å…¥ç›¸ä½
- PA6 â†’ PB1ï¼šPA6æ˜¯è¾“å…¥ï¼ŒPB1æ˜¯è¾“å‡º
- æ‰€ä»¥ï¼šÎ¸ = PB1 - PA6

---

### â“ **é—®é¢˜2ï¼šPA6å’ŒPB1çš„è§’è‰²å®šä¹‰æ¨¡ç³Š**

**ä»ä»£ç æ³¨é‡Šçœ‹**ï¼š
```c
/* PA6 (CH6): è¾“å…¥å‚è€ƒK */
/* PB1 (CH9): è¾“å‡ºæµ‹é‡Kâ‚ */
```

**ä»ç”µè·¯çœ‹**ï¼š
```
DAC â†’ U1A â†’ PA6 â†’ [è¿æ”¾] â†’ PB1
```

**ç»“è®º**ï¼š
- PA6 = "è¾“å…¥"ï¼ˆä¸­é—´çº§å‚è€ƒç‚¹ï¼‰
- PB1 = "è¾“å‡º"ï¼ˆæœ€ç»ˆè¾“å‡ºï¼‰
- H(Ï‰) = PB1/PA6 âœ…
- Î¸(Ï‰) = PB1ç›¸ä½ - PA6ç›¸ä½ âŒ (ä»£ç ä¸­åäº†)

---

## ğŸ”§ å¿…é¡»ä¿®æ”¹çš„ä»£ç 

### ä¿®æ”¹1ï¼šç›¸ä½è®¡ç®—

**æ–‡ä»¶**: `firmware/USER/main.c`
**è¡Œæ•°**: çº¦279è¡Œ

**å½“å‰**ï¼š
```c
float phase_diff_rad = phase1_rad - phase2_rad;  // PA6 - PB1
```

**æ”¹ä¸º**ï¼š
```c
float phase_diff_rad = phase2_rad - phase1_rad;  // PB1 - PA6
```

---

## âœ… éªŒè¯é¢„æœŸç»“æœ

### ä¿®æ”¹å‰ï¼ˆé”™è¯¯ï¼‰ï¼š
```
100Hz: Î¸ = PA6 - PB1 = -38.62Â°
```
**ç‰©ç†æ„ä¹‰**ï¼šPA6ç›¸ä½æ»åäºPB1ï¼ˆä¸åˆç†ï¼ï¼‰

### ä¿®æ”¹åï¼ˆæ­£ç¡®ï¼‰ï¼š
```
100Hz: Î¸ = PB1 - PA6 = +38.62Â°
```
**ç‰©ç†æ„ä¹‰**ï¼šPB1ç›¸ä½è¶…å‰äºPA6ï¼ˆåˆç†ï¼å› ä¸ºä¿¡å·ç»è¿‡è¿æ”¾ä¼šäº§ç”Ÿç›¸ç§»ï¼‰

---

## ğŸ“Š å…¶ä»–è®¡ç®—éªŒè¯

### H(Ï‰)è®¡ç®— âœ…
```
H = PB1/PA6 = 0.4000/0.1900 = 2.105 âœ… ç¬¦åˆæ”¾å¤§ç”µè·¯ç‰¹æ€§
```

### ADCç²¾åº¦ âœ…
```
12ä½ADC: 0-4095
ç²¾åº¦: 3.3V / 4096 â‰ˆ 0.806mV
```

### æµ®ç‚¹æ•°ç²¾åº¦ âœ…
```
float: å•ç²¾åº¦æµ®ç‚¹æ•°ï¼Œçº¦7ä½æœ‰æ•ˆæ•°å­—
è¶³å¤Ÿç”¨äºç”µå‹å’Œå¢ç›Šè®¡ç®—
```

---

## ğŸ¯ æ€»ç»“

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| ADCæ•°æ®æå– | âœ… æ­£ç¡® | ä½16ä½=PA6, é«˜16ä½=PB1 |
| å³°å³°å€¼è®¡ç®— | âœ… æ­£ç¡® | max - min |
| ç”µå‹è½¬æ¢ | âœ… æ­£ç¡® | (ADC Ã— 3.3) / 4096 |
| H(Ï‰)è®¡ç®— | âœ… æ­£ç¡® | PB1 / PA6 |
| ç›¸ä½è®¡ç®— | âŒ **é”™è¯¯** | åº”è¯¥æ˜¯ PB1 - PA6ï¼Œè€Œä¸æ˜¯ PA6 - PB1 |
| ADCç²¾åº¦ | âœ… æ­£ç¡® | 12ä½ |
| æµ®ç‚¹æ•°ä½¿ç”¨ | âœ… æ­£ç¡® | ä½¿ç”¨float |

**å”¯ä¸€éœ€è¦ä¿®æ”¹çš„ï¼šç›¸ä½å·®è®¡ç®—é¡ºåºï¼**












