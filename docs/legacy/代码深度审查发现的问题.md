# ä»£ç æ·±åº¦å®¡æŸ¥ - å‘ç°çš„é—®é¢˜

## ğŸ”´ ä¸¥é‡é—®é¢˜

### 1. âŒ **æ ¡å‡†ç³»æ•°è®¡ç®— - æ½œåœ¨æº¢å‡º**
**ä½ç½®**: `main.c:903`  
**é—®é¢˜ä»£ç **:
```c
g_calibration.gain_correction[freq_idx] = (uint16_t)(100000000UL / H_measured);
```

**é—®é¢˜åˆ†æ**:
```c
å¦‚æœ H_measured = 100 (H = 0.01)
ç»“æœ = 100000000 / 100 = 1000000
uint16_tæœ€å¤§å€¼ = 65535
æº¢å‡ºï¼å®é™…å­˜å‚¨å€¼ = 1000000 % 65536 = 16960 (é”™è¯¯ï¼)
```

**ä¿®å¤æ–¹æ¡ˆ**:
```c
// æ–¹æ¡ˆ1ï¼šé™åˆ¶èŒƒå›´
uint32_t correction = 100000000UL / H_measured;
if(correction > 65535) correction = 65535;  // é™åˆ¶åˆ°æœ€å¤§å€¼
g_calibration.gain_correction[freq_idx] = (uint16_t)correction;

// æ–¹æ¡ˆ2ï¼šæ”¹å˜æ•°æ®ç±»å‹ï¼ˆæ›´å¥½ï¼‰
uint32_t gain_correction[CALIBRATION_POINTS];  // æ”¹ç”¨uint32_t
```

---

### 2. âŒ **SPIæ¥å£æè¿°ä¸ä¸€è‡´**
**ä½ç½®**: å¤šå¤„

**ä¸ä¸€è‡´**:
- æ³¨é‡Šè¯´ï¼šSPI0 âœ…
- ä»£ç è¯´ï¼šSPI0 âœ…  
- æ‰“å°è¯´ï¼šSPI1 âŒ

**éœ€è¦ä¿®æ­£çš„åœ°æ–¹**:
```c
line 85:  "via SPI1" â†’ "via SPI0"
line 92:  "SPI1æ¥å£" â†’ "SPI0æ¥å£"
line 94:  "via SPI1" â†’ "via SPI0"
line 124: "SPI1" â†’ "SPI0"
```

---

### 3. âš ï¸ **ç‰ˆæœ¬å·ä¸ä¸€è‡´**
**ä½ç½®**: `main.c:3` vs `main.c:83`

**ä¸ä¸€è‡´**:
- æ³¨é‡Šï¼šv5.5 âœ…
- æ‰“å°ï¼šv5.0 âŒ

**ä¿®å¤**:
```c
printf("  GD32F103 Bode Plot Analyzer v5.0\r\n");
// æ”¹ä¸ºï¼š
printf("  GD32F103 Bode Plot Analyzer v5.5\r\n");
```

---

## ğŸŸ¡ ä¸­ç­‰é—®é¢˜

### 4. âš ï¸ **é”™è¯¯ä¿¡æ¯è¯¯å¯¼**
**ä½ç½®**: `main.c:395-398`

**é—®é¢˜**:
```c
printf("  1. PWM output not connected (PA6/PB1)\r\n");  // è¯¯å¯¼ï¼ç³»ç»Ÿä¸ç”¨PWM
printf("  2. RC filter not connected\r\n");             // è¯¯å¯¼ï¼ä¸éœ€è¦RCæ»¤æ³¢å™¨
```

**ä¿®å¤**:
```c
printf("  1. DACè¾“å‡ºæœªè¿æ¥\r\n");
printf("  2. è¿æ”¾ç”µè·¯æœªå·¥ä½œ\r\n");
printf("  3. è¢«æµ‹ç”µè·¯(DUT)æœªè¿æ¥\r\n");
printf("  4. ADCè¾“å…¥æœªè¿æ¥ (PA6/PB1)\r\n");
```

---

### 5. âš ï¸ **ç¡¬ç¼–ç çš„é­”æ•°**
**ä½ç½®**: å¤šå¤„

**é—®é¢˜**:
```c
delay_ms(3000);          // ç¡¬ç¼–ç ï¼Œä¸æ˜æ˜¾
if(settle_time_ms < 100) // 100æ˜¯ä»€ä¹ˆï¼Ÿ
```

**å»ºè®®**:
```c
#define CALIBRATION_WAIT_MS  3000
#define MIN_SETTLE_TIME_MS   100
```

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜

### 6. ğŸ“ **æ³¨é‡Šä¸å‡†ç¡®**
**ä½ç½®**: `main.c:413`

**é—®é¢˜**:
```c
/* 5. è®¡ç®—å¹…é¢‘ç‰¹æ€§ H = K1/K (å‡è®¾CH1æ˜¯è¾“å…¥ï¼ŒCH2æ˜¯è¾“å‡º) */
```

**å®é™…**:
- CH1 = PA6 = è¾“å…¥å‚è€ƒï¼ˆæ­£ç¡®ï¼‰
- CH2 = PB1 = è¾“å‡ºæµ‹é‡ï¼ˆæ­£ç¡®ï¼‰
- ä½†ä¸æ˜¯"å‡è®¾"ï¼Œæ˜¯ç¡®å®šçš„ï¼

**ä¿®å¤**:
```c
/* 5. è®¡ç®—å¹…é¢‘ç‰¹æ€§ H(Ï‰) = Kâ‚/K (CH1=è¾“å…¥K, CH2=è¾“å‡ºKâ‚) */
```

---

### 7. ğŸ“ **ç”µå‹è½¬æ¢æ³¨é‡Šé”™è¯¯**
**ä½ç½®**: `main.c:409`

**é—®é¢˜**:
```c
/* 4. è½¬æ¢ä¸ºç”µå‹ï¼ˆæ•´æ•°è¿ç®—ï¼Œå•ä½ï¼šmVÃ—100ï¼Œå³°å³°å€¼ï¼‰ */
uint32_t voltage_ch1_mv = ((uint32_t)pp_ch1 * 3300) / 4096;
```

**å®é™…**:
- æ³¨é‡Šè¯´"mVÃ—100"
- ä½†å®é™…æ˜¯"mV"ï¼ˆæ²¡æœ‰Ã—100ï¼‰

**ä¿®å¤**:
```c
/* 4. è½¬æ¢ä¸ºç”µå‹ï¼ˆmVï¼Œå³°å³°å€¼ï¼‰ */
```

---

### 8. âš ï¸ **æ‰«é¢‘æ—¶é™æ€å˜é‡é‡å¤å£°æ˜**
**ä½ç½®**: `main.c:625, 881`

**é—®é¢˜**:
```c
// AutoSweepå‡½æ•°é‡Œ
static uint16_t adc0_data[512];  
static uint16_t adc1_data[512];

// AutoCalibrationå‡½æ•°é‡Œåˆå£°æ˜äº†ä¸€æ¬¡
static uint16_t adc0_data[512];
static uint16_t adc1_data[512];
```

**åˆ†æ**:
- æ¯ä¸ªå‡½æ•°æœ‰è‡ªå·±çš„staticå˜é‡ï¼ˆæ­£ç¡®ï¼‰
- ä½†ä¼šå ç”¨é¢å¤–çš„1KB+1KBå†…å­˜
- å¦‚æœRAMç´§å¼ ï¼Œå¯ä»¥å…±ç”¨

---

## ğŸ” é€»è¾‘ç»†èŠ‚æ£€æŸ¥

### 9. âœ… **ExtractADCDataè¾¹ç•Œæ£€æŸ¥**
```c
for(uint32_t i = 0; i < count && i < ADC_BUFFER_SIZE; i++)
```
âœ… æ­£ç¡®ï¼åŒé‡ä¿æŠ¤

### 10. âœ… **CalculateDCOffsetæº¢å‡ºä¿æŠ¤**
```c
uint32_t sum = 0;  // 512 Ã— 4095 = 2096640 < 2^32 âœ…
```
âœ… æ­£ç¡®ï¼ä¸ä¼šæº¢å‡º

### 11. âœ… **ç›¸ä½å½’ä¸€åŒ–**
```c
while(phase_diff_deg > 18000.0f) phase_diff_deg -= 36000.0f;
while(phase_diff_deg < -18000.0f) phase_diff_deg += 36000.0f;
```
âœ… æ­£ç¡®ï¼

### 12. âš ï¸ **æµ®ç‚¹æ¯”è¾ƒ**
```c
if(voltage_ch1 > 0.001f)  // ä½¿ç”¨é˜ˆå€¼ âœ…
if(fundamental < 1.0f)    // ä½¿ç”¨é˜ˆå€¼ âœ…
```
âœ… æ­£ç¡®ï¼é¿å…äº†ç›´æ¥ä¸0æ¯”è¾ƒ

---

## ğŸ“Š æ€§èƒ½åˆ†æ

### å†…å­˜ä½¿ç”¨
```
å…¨å±€å˜é‡:
- g_calibration: 100Ã—2 + 100Ã—2 = 400å­—èŠ‚
- é™æ€ç¼“å†²åŒº (per function): 512Ã—2Ã—2 = 2KB

æ ˆä½¿ç”¨ (worst case):
- AutoSweep: ~2KBå±€éƒ¨å˜é‡
- æ·±åº¦é€’å½’: æ— 

æ€»è®¡: ~3-4KB (GD32F103æœ‰20KB RAM) âœ… å®‰å…¨
```

### CPUä½¿ç”¨
```
DFTè®¡ç®— (512ç‚¹):
- sin/cosè°ƒç”¨: 512 Ã— 2 = 1024æ¬¡
- æµ®ç‚¹è¿ç®—: ~3000æ¬¡
- æ—¶é—´ä¼°è®¡: <10ms @ 72MHz âœ… å¯æ¥å—
```

---

## ğŸ¯ å»ºè®®ä¿®å¤ä¼˜å…ˆçº§

### P0 (å¿…é¡»ä¿®å¤):
1. âœ… æ ¡å‡†ç³»æ•°æº¢å‡ºé—®é¢˜
2. âœ… SPIæ¥å£æè¿°é”™è¯¯
3. âœ… ç‰ˆæœ¬å·ä¸ä¸€è‡´

### P1 (åº”è¯¥ä¿®å¤):
4. âš ï¸ é”™è¯¯ä¿¡æ¯æ”¹è¿›
5. âš ï¸ æ³¨é‡Šå‡†ç¡®æ€§

### P2 (å¯é€‰):
6. ğŸ“ ä»£ç é£æ ¼ç»Ÿä¸€
7. ğŸ“ é­”æ•°æ”¹ä¸ºå¸¸é‡



