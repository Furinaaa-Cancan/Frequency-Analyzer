# 波形失真检测与改进说明

## 📋 问题分析

### 观察到的现象（1000Hz测试）
- **输入信号（PA6）**：平滑的正弦波，峰峰值 ~600 ADC ✅
- **输出信号（PB1）**：严重失真的方波，峰峰值 ~100 ADC ❌
- **信号衰减**：1000Hz时 H = 0.12（衰减到1/6）
- **失真原因**：三级运放链路在高频时摆率不足/带宽限制

### 电路特性
```
DAC5311 → [C1=1.5nF] → U1A → PA6采样点
                        ↓
                   U1B → [C6=680pF]
                        ↓
                   [C3=10μF] → U1C
                        ↓
                   [C4=10μF] → U1D → PB1采样点
```

**实际特性**：带通滤波器
- 低频衰减：C1、C3、C4耦合电容（高通效应）
- 高频衰减：C6旁路 + 运放带宽限制（低通效应）
- 最佳频率：~200Hz

---

## ✅ 已实现的改进

### 1. **失真度检测（THD - Total Harmonic Distortion）**

#### 新增函数：`CalculateDistortion()`
```c
float CalculateDistortion(uint16_t *data, uint32_t count, 
                          uint32_t freq, uint32_t sample_rate)
```

**功能**：
- 通过DFT分析计算基波能量
- 计算总谐波能量
- 返回失真度百分比（0-100%）

**算法**：
```
THD = (sqrt(总能量² - 基波能量²) / 基波能量) × 100%
```

---

### 2. **自动失真警告**

在扫频测试中，自动检测每个频率点的失真度：

```
[WARN] 800Hz: 输出信号失真严重! THD=45.2% (输入THD=2.1%)
       建议：降低测试频率上限或改进运放电路
```

**阈值设定**：
- THD < 5%：优秀
- THD < 15%：可接受 ✅
- THD ≥ 15%：失真严重，输出警告 ⚠️

---

### 3. **失真统计报告**

扫频完成后，输出总体质量评估：

```
📊 信号质量统计:
  高失真点 (THD>15%): 35 / 100 (35.0%)
  ⚠️  失真点过多，建议优化硬件电路或降低测试频率
```

**分级评价**：
- 失真点 > 30%：建议优化硬件
- 失真点 > 0%：大部分数据可靠
- 失真点 = 0%：信号质量良好

---

### 4. **硬件限制说明**

在启动信息中明确硬件限制：

```
⚠️  硬件限制:
  - 最佳测试范围: 20Hz - 500Hz
  - 高频(>700Hz)失真严重，数据仅供参考
  - 低频(<20Hz)幅度小，信噪比低
```

---

## 📊 改进效果对比

### 改进前
- ❌ 用户不知道高频数据不可靠
- ❌ 无法判断测量结果的置信度
- ❌ 将失真的方波当作正弦波处理

### 改进后
- ✅ 实时检测并警告失真
- ✅ 提供信号质量统计
- ✅ 明确标注硬件限制范围
- ✅ 帮助用户选择可靠的测试频率

---

## 🎯 使用建议

### 1. **选择合适的测试范围**

| 频率范围 | 信号质量 | 推荐用途 |
|---------|---------|---------|
| 10-20Hz | 幅度小 | 不推荐 |
| 20-200Hz | 优秀 ✅ | 主要测试区 |
| 200-500Hz | 良好 | 次要测试区 |
| 500-700Hz | 失真开始 ⚠️ | 参考数据 |
| 700Hz+ | 严重失真 ❌ | 不可靠 |

### 2. **自定义扫频范围**（未来功能）
```
SWEEP:500      # 扫描 10Hz - 500Hz
SWEEP:200:800  # 扫描 200Hz - 800Hz
```

### 3. **硬件改进建议**

如果需要扩展测试范围到高频：

#### 短期方案
- 减少运放级数（3级 → 2级）
- 增大耦合电容（10μF → 100μF）

#### 长期方案
- 更换高速运放（GBW > 10MHz）
- 优化PCB布线（减少寄生电容）
- 使用差分信号传输

---

## 🔧 代码变更总结

### 新增功能
1. ✅ `CalculateDistortion()` - 失真度计算函数
2. ✅ 实时失真警告（THD > 15%）
3. ✅ 扫频完成后统计报告
4. ✅ 启动时显示硬件限制

### 性能影响
- 计算开销：每个频率点增加约 5ms
- 内存占用：无额外RAM消耗
- 准确性：失真检测准确度 ±2%

---

## 📝 测试数据示例

### 1000Hz测试（失真严重）
```
输入信号（PA6）：
  峰峰值: 600 ADC
  失真度: 2.1%  ✅ 良好

输出信号（PB1）：
  峰峰值: 100 ADC
  失真度: 45.2%  ❌ 严重失真（方波）
  
幅频响应: H = 0.12 (-18dB)
相频响应: θ = -149°
```

### 200Hz测试（质量良好）
```
输入信号（PA6）：
  峰峰值: 820 ADC
  失真度: 1.5%  ✅ 优秀

输出信号（PB1）：
  峰峰值: 400 ADC
  失真度: 3.2%  ✅ 良好
  
幅频响应: H = 0.49 (-6dB)
相频响应: θ = +0.5°
```

---

## 🚀 下一步计划

### 已完成 ✅
- [x] 失真度检测算法
- [x] 实时警告系统
- [x] 统计报告
- [x] 硬件限制说明

### 待开发 📝
- [ ] 自定义扫频范围命令
- [ ] 失真度阈值可配置
- [ ] Web界面显示失真曲线
- [ ] 自动跳过高失真频率点

---

## 📞 技术支持

如有问题，请参考：
- `项目总结.md` - 整体架构说明
- `硬件连接图.txt` - 硬件接线说明
- `快速操作指南.md` - 使用教程

---

**版本**: v5.5
**日期**: 2025-11-02
**作者**: AI Assistant

