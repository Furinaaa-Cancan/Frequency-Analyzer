# 代码严格审查报告

## 📅 审查时间
2025年10月31日

## 🎯 审查范围
- 固件代码（GD32F103）
- ADC配置和数据提取
- DDS信号生成
- 数据处理算法
- 前端React应用

---

## ⚠️ 严重问题 (Critical)

### 🔴 **问题1：ADC数据提取顺序与官方文档矛盾**

**位置**: `firmware/USER/main.c:177-185`

**问题描述**:
根据GD32官方文档 (`gd32f10x_adc.h`):
```c
/* ADC_RDATA寄存器定义 */
#define ADC_RDATA_RDATA      BITS(0,15)   /*!< ADC0 regular data - 低16位 */
#define ADC_RDATA_ADC1RDTR   BITS(16,31)  /*!< ADC1 regular data - 高16位 */
```

**官方规定**:
- **低16位 (0-15)** = ADC0数据 (PA6 / CH6)
- **高16位 (16-31)** = ADC1数据 (PB1 / CH9)

**当前代码**:
```c
void ExtractADCData(uint16_t *adc0_data, uint16_t *adc1_data, uint32_t count)
{
    for(uint32_t i = 0; i < count && i < ADC_BUFFER_SIZE; i++)
    {
        adc0_data[i] = (uint16_t)((adc_buffer[i] >> 16) & 0xFFFF);  /* 高16位 */
        adc1_data[i] = (uint16_t)(adc_buffer[i] & 0xFFFF);          /* 低16位 */
    }
}
```

**实际结果**:
- `adc0_data` = 高16位 = **实际是ADC1(PB1)的数据**
- `adc1_data` = 低16位 = **实际是ADC0(PA6)的数据**

**后续影响**:
```c
pp_ch1 = CalculatePeakToPeak(adc0_data);  // 实际是PB1数据
pp_ch2 = CalculatePeakToPeak(adc1_data);  // 实际是PA6数据
H = pp_ch2 / pp_ch1;  // = PA6/PB1 = 1/H(真实)
```

**结论**:
- 如果文档正确：H(ω)计算结果是倒数！
- 如果测量结果H>1正确：说明实际硬件数据格式与文档相反

**建议**:
1. 使用示波器同时测量PA6和PB1电压
2. 对比ADC采样值确认数据对应关系
3. 或使用上面的`ADC_DataFormat_DebugTest()`函数验证

---

## ⚠️ 一般问题 (Major)

### 🟡 **问题2：注释与代码不一致**

**位置**: 多处

**问题描述**:
- `main.c:181` 注释说"低16位=ADC1(从)，高16位=ADC0(主)"
- 但提取代码是：`adc0_data = 高16位, adc1_data = 低16位`
- 如果注释正确，那么：
  - adc0_data实际装的是ADC1数据
  - adc1_data实际装的是ADC0数据

**修复建议**:
统一注释和代码逻辑，或进行实测验证。

---

### 🟡 **问题3：变量命名混淆**

**问题描述**:
```c
// 变量名暗示含义：
uint16_t pp_ch1;  // 应该是"通道1"的峰峰值
uint16_t pp_ch2;  // 应该是"通道2"的峰峰值

// 但实际：
pp_ch1 = CalculatePeakToPeak(adc0_data);  // adc0_data可能是ADC1的数据
pp_ch2 = CalculatePeakToPeak(adc1_data);  // adc1_data可能是ADC0的数据
```

**修复建议**:
使用更明确的命名：
```c
uint16_t pp_pa6 = CalculatePeakToPeak(pa6_samples);
uint16_t pp_pb1 = CalculatePeakToPeak(pb1_samples);
H = pp_pb1 / pp_pa6;
```

---

## ✅ 正确的部分 (Correct)

### ✅ **1. ADC硬件配置**
```c
// adc.c: 配置正确
ADC0_CH6 (PA6) - 模拟输入配置 ✓
ADC1_CH9 (PB1) - 模拟输入配置 ✓
双ADC同步模式 ✓
TIMER3触发 ✓
```

### ✅ **2. DMA配置**
```c
// dma.c: 配置正确
32位数据传输 ✓
循环模式 ✓
从ADC0_RDATA读取 ✓
缓冲区大小256 ✓
```

### ✅ **3. 相位计算算法**
```c
// main.c: EstimatePhaseShift_Int()
DFT算法实现正确 ✓
去直流偏移 ✓
atan2f计算相位 ✓
相位归一化到±180° ✓
```

### ✅ **4. 峰峰值计算**
```c
// main.c: CalculatePeakToPeak()
遍历寻找最大最小值 ✓
计算差值 ✓
逻辑简单清晰 ✓
```

### ✅ **5. H(ω)计算公式**
```c
H_x10000 = (pp_ch2 * 10000) / pp_ch1;
```
公式正确（前提是pp_ch1和pp_ch2对应关系正确）✓

---

## 🔍 需要验证的问题

### 🟠 **验证1：ADC数据顺序**

**测试步骤**:
1. 使用示波器测量PA6和PB1电压
2. 记录实际电压值（例如PA6=0.2V, PB1=0.4V）
3. 运行程序，查看串口输出的K和K₁
4. 对比：
   - 如果K=0.2V, K₁=0.4V → 数据顺序正确
   - 如果K=0.4V, K₁=0.2V → 数据顺序反了

**或者使用调试代码**:
将`ADC数据格式验证测试.c`中的函数添加到main.c，运行查看输出。

---

### 🟠 **验证2：H(ω)计算正确性**

**已知数据**:
```
200Hz: K=0.21V, K₁=0.40V, H=1.9
```

**验证**:
- 计算: 0.40/0.21 = 1.90 ✓
- 结论: 如果PA6=0.21V, PB1=0.40V，则H计算正确

**需要确认**: 串口输出的K和K₁到底对应哪个引脚？

---

## 📊 测量结果分析

### **"浴盆型"曲线的合理性**

根据电路结构：
```
DAC5311 → [C1高通] → [U1A跟随器] → PA6 → [U1B] → [U1C] → PB1
```

**低频段(10-50Hz)**: H=3-5倍
- 原因: C1高通截止，PA6衰减
- 物理合理 ✓

**中频段(100-500Hz)**: H=1.8-2.2倍
- 原因: 正常工作区，真实增益
- 物理合理 ✓

**高频段(700-1000Hz)**: H=3-4倍
- 原因: U1A带宽限制，PA6衰减
- 物理合理 ✓

**结论**: 如果数据顺序正确，曲线是合理的！

---

## 🎯 建议的修复方案

### **方案A：硬件验证法（推荐）**

1. 使用万用表/示波器测量PA6和PB1实际电压
2. 对比串口输出的K和K₁
3. 确认对应关系
4. 如果反了，交换ExtractADCData中的提取顺序

### **方案B：软件调试法**

1. 添加调试输出代码
2. 打印DMA缓冲区原始数据
3. 分别打印高16位和低16位
4. 根据幅度判断谁是PA6谁是PB1

### **方案C：理论推导法**

基于测量数据判断：
- PB1 > PA6（因为有放大）
- 如果高16位数据 > 低16位数据 → 高16位=PB1
- 如果低16位数据 > 高16位数据 → 低16位=PB1

---

## 📝 代码质量评价

### **优点**:
1. ✅ 代码结构清晰，模块化好
2. ✅ ADC/DMA/DDS配置完整
3. ✅ 相位算法实现正确
4. ✅ 注释详细（虽然部分不一致）
5. ✅ 错误处理较完善

### **缺点**:
1. ❌ ADC数据提取逻辑与文档矛盾
2. ❌ 注释与代码不一致
3. ❌ 变量命名容易混淆
4. ⚠️ 缺少数据顺序验证机制

### **总体评分**: 7.5/10

**扣分项**:
- 数据顺序问题 (-2分)
- 注释不一致 (-0.5分)

**加分项**:
- 完整的功能实现 (+1分)
- 良好的代码组织 (+1分)

---

## 🚀 下一步行动

### **紧急任务** (必须完成):
1. **验证ADC数据顺序** - 使用硬件测试或调试代码
2. **修正数据提取逻辑** - 根据验证结果修改
3. **统一注释和代码** - 消除矛盾

### **改进任务** (建议完成):
1. 改进变量命名（pp_ch1 → pp_pa6）
2. 添加自检功能（启动时验证数据顺序）
3. 增加更多的数据有效性检查

---

## 🏁 最终结论

**代码整体质量**: 良好

**关键问题**: ADC数据提取顺序需要验证

**建议**: 
1. 立即运行硬件测试验证数据顺序
2. 根据验证结果决定是否需要修改代码
3. 如果当前测量结果合理，可能不需要修改

**如果H(ω)测量结果符合物理预期（PB1>PA6，H>1），说明当前代码是正确的，虽然与GD32文档描述不完全一致。**












