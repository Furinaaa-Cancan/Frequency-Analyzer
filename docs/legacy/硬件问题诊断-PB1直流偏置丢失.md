# 硬件问题诊断：PB1直流偏置丢失导致测量失真

## 🔴 问题确认

### 观察到的现象
```
PA6（输入参考）:
  - ADC范围: 207 - 815 (峰峰值608)
  - 中心值: ~511 (约1.65V)
  - 波形: 完美正弦波 ✅

PB1（输出测量）:
  - ADC范围: 0 - 93 (峰峰值93)
  - 中心值: ~46 (约0.037V)
  - 波形: 削波的半波 ❌
```

### 🎯 根本原因

**PB1信号的直流偏置被耦合电容C3和C4滤除了！**

```
信号路径分析：

U1A输出 → PA6采样
  ↓  [信号: 1.65V ± 0.25V正弦波]
  ↓
U1B输出
  ↓  [信号: 仍有1.65V直流偏置]
  ↓
C3 (10μF耦合电容) ← 💀 直流被滤除！
  ↓  [信号: 0V ± 某个交流幅度]
  ↓
U1C输出
  ↓  [信号: 仍然没有直流偏置]
  ↓
C4 (10μF耦合电容) ← 💀 继续滤除直流！
  ↓  [信号: 0V ± 微弱交流]
  ↓
U1D输出 → PB1采样
  ↓  [信号: -50mV ~ +50mV 交流信号]
  ↓
ADC采样（只能测0-3.3V）
  结果: 负半周被削波到0！
```

---

## 📊 问题详细分析

### 1. 为什么PB1峰峰值这么小？（只有93 ADC）

**理论分析**：
```
PA6幅度: 608 ADC → 约490mV峰峰值
电路衰减: H(1000Hz) ≈ 0.15
预期PB1幅度: 490mV × 0.15 = 73.5mV

实测PB1幅度: 93 ADC → 约75mV峰峰值 ✅ 符合预期！
```

**所以幅度本身是对的，但是...**

### 2. 为什么波形变成方波？

**实际波形**：
```
理想PB1信号（运放输出）:
     ～～～
   ／    ＼
  ／      ＼
 ／        ＼
───1.65V────  ← 直流偏置
 ＼        ／
  ＼      ／
   ＼    ／
     ～～～
     
实际PB1信号（经过C3/C4后）:
      ～～～
    ／    ＼
   ／      ＼    ← 正半周保留
  ／        ＼
─────0V──────
 ╱          ╲   ← 负半周被ADC削到0
╱            ╲
             
结果：半波整流 + 失真
```

### 3. ADC只能测量0-3.3V

```
ADC测量范围限制：

输入信号 < 0V    → ADC读到 0
输入信号 0-3.3V  → ADC读到 0-4095
输入信号 > 3.3V  → ADC读到 4095（饱和）

当PB1信号中心在0V时：
  正半周(0-75mV)   → ADC读到 0-93   ✅
  负半周(-75mV-0)  → ADC读到 0      ❌ 削波！
```

---

## 🔧 解决方案

### 方案A：添加直流偏置电路（推荐）✅

#### 硬件修改：在PB1和ADC之间添加偏置

```
修改方案1：电阻分压偏置
                                    
    PB1 ──────R1(10kΩ)──────┬────── 到ADC采样引脚
                            │
                          R2(10kΩ)
                            │
                           3.3V
                           
    效果：信号中心偏置到1.65V
    成本：2个电阻
    缺点：信号幅度减半

修改方案2：运放求和电路（最佳）
                                    
                        R2(10k)
    PB1 ───R1(10k)────┬──\/\/\/──┐
                      │          │
                      │      ┌───┴───┐
                      │      │   -   │
                      │      │       ├──── 到ADC
    1.65V ────R3────  │   ┌──│   +   │
         (基准电压)   │   │  └───────┘
                      │   │   运放
                     GND  │
                          GND
                          
    效果：信号中心精确偏置到1.65V
    成本：1个运放 + 3个电阻
    优点：信号幅度不衰减
```

#### 实施步骤：
1. 断开PB1到ADC的直接连接
2. 添加偏置电路
3. 连接偏置后的信号到ADC引脚
4. 重新测试

---

### 方案B：改变PA6采样点（替代方案）✅

**思路**：既然PB1有问题，那就改采样别的点

```
当前配置：
  PA6 = U1A输出（有偏置）✅
  PB1 = U1D输出（无偏置）❌
  
新配置：
  PA6 = U1A输出（参考信号）✅
  PB1 = U1B输出（在C3之前采样）✅
  
修改：把PB1的ADC连接改到U1B输出（在C3之前）
```

#### 优点：
- 不需要增加元件
- U1B输出仍有直流偏置
- 只需飞线改接

#### 缺点：
- 减少了一级放大
- 测量的不是最终输出

---

### 方案C：移除耦合电容（激进方案）⚠️

```
直接短接C3和C4（用导线代替）

优点：
  - 最简单
  - 恢复直流偏置
  
缺点：
  - 改变电路特性
  - 可能影响各级运放工作点
  - 不建议，除非重新计算各级偏置
```

---

### 方案D：软件校正（临时方案）🟡

**当前只能用这个，因为硬件已经做好了**

#### 软件策略：
1. **承认数据不准确**
   - PB1测到的是半波整流信号
   - 幅度大约对（×2可以得到真实峰峰值）
   - 相位不准（因为削波）

2. **添加警告**
   ```c
   printf("[WARN] PB1信号无直流偏置，ADC削波严重！\r\n");
   printf("       实际幅度约为测量值的2倍\r\n");
   printf("       相位测量不可靠\r\n");
   ```

3. **估算真实幅度**
   ```c
   // 假设负半周被完全削波
   uint16_t estimated_pp = measured_pp * 2;
   ```

---

## 📈 修复后的预期效果

### 修复前（当前状态）：
```
PA6: 207-815 (峰峰值608) 完美正弦波
PB1: 0-93   (峰峰值93)  半波整流

幅频测量: 不准确（只测到一半幅度）
相频测量: 完全错误（削波导致相位失真）
```

### 修复后（添加偏置）：
```
PA6: 207-815  (峰峰值608)   完美正弦波
PB1: 2002-2095 (峰峰值93)   完美正弦波！
              👆 中心在2048 (1.65V)

幅频测量: 准确 ✅
相频测量: 准确 ✅
```

---

## 🎯 建议行动

### 立即可做（软件）：
1. ✅ 更新代码注释，说明硬件问题
2. ✅ 添加警告信息
3. ⚠️ 承认当前测量局限性

### 短期修复（简单硬件）：
1. 🔧 方案A：添加电阻分压偏置（10分钟）
2. 🔧 方案B：改接PB1到U1B输出（5分钟）

### 长期改进（重新设计）：
1. 📐 移除不必要的耦合电容
2. 📐 简化运放级数
3. 📐 添加专用偏置电路

---

## 📝 验证方法

### 修复后如何确认问题解决？

**用示波器或串口监测看到**：
```
修复前:
  PB1中心: ~46 ADC (0.037V)  ❌
  PB1范围: 0-93              ❌
  
修复后:
  PB1中心: ~2048 ADC (1.65V) ✅
  PB1范围: 2002-2095         ✅
```

**幅频响应变化**：
```
修复前: H(200Hz) = 0.49  (看起来正常)
        H(1000Hz) = 0.15 (但波形失真)
        
修复后: H(200Hz) = 0.49  (波形完美)
        H(1000Hz) = 0.15 (波形仍失真，但这是运放限制)
```

---

## 总结

**你的问题不是位数或精度问题，而是硬件电路设计问题！**

- ✅ ADC配置正确（12位，双通道）
- ✅ DMA配置正确（32位传输）
- ✅ 数据提取正确（低16位=ADC0，高16位=ADC1）
- ❌ **硬件问题：PB1没有直流偏置，ADC削波**

**最简单的修复**：添加电阻分压给PB1提供1.65V偏置！

---

**版本**: v5.5
**日期**: 2025-11-02
**严重程度**: 高（影响测量准确性）

