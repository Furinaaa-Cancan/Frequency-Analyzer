# 伯德图分析仪 - 软件校准功能使用说明

## 📋 功能概述

软件校准功能用于补偿PA6信号在高频的衰减问题，通过直通测试获取系统本身的频率响应，然后在实际测量中自动修正，得到被测电路（DUT）的真实频率特性。

---

## 🔧 校准原理

### 问题分析

PA6作为参考信号，理想情况下应该在所有频率保持恒定幅度，但由于：
- U1A运放输出能力限制
- 反馈电容C1、C2的滤波作用
- 负载驱动能力不足

导致PA6信号在高频（>700Hz）出现显著衰减（最高达40%）。

### 校准方案

```
步骤1：直通校准测试
PA6 ──短接线──> PB0
测量：H_calib(ω), θ_calib(ω)
理论值：H≈1.0, θ≈0°

步骤2：保存校准系数
gain_correction[freq] = 1.0 / H_calib(ω)
phase_correction[freq] = -θ_calib(ω)

步骤3：实际测量时应用修正
H_corrected = H_measured × gain_correction
θ_corrected = θ_measured + phase_correction
```

---

## 📖 使用步骤

### 1️⃣ 准备校准

**硬件连接：**
```
1. 断开所有被测电路（DUT）
2. 用短导线连接：PA6 → PB0
3. 确保连接牢固，无接触不良
```

⚠️ **重要提示**：
- 必须是直通连接，不要经过任何其他电路
- 连线尽量短，减少寄生电容
- 确保GND共地

---

### 2️⃣ 开始校准

**前端操作：**

1. 打开Web前端应用
2. 连接串口
3. 点击 **"🔧 开始校准"** 按钮
4. 确认对话框中的提示
5. 等待校准完成（约2-3分钟）

**串口命令（可选）：**
```
CALIBRATE
或
CALIB
```

---

### 3️⃣ 校准过程

固件会自动执行以下步骤：

```
1. 扫频测量：10Hz → 1000Hz（100个频率点）
2. 每个频率等待信号稳定（低频较长）
3. 测量幅度：H_calib = PB0幅度 / PA6幅度
4. 测量相位：θ_calib = PB0相位 - PA6相位
5. 计算校准系数并保存到内存
6. 输出校准数据：CALIB_DATA:freq,H,θ
```

**预期校准数据示例：**

| 频率 | H_calib | θ_calib | 说明 |
|------|---------|---------|------|
| 100Hz | 1.00 | 0° | 理想值 |
| 500Hz | 1.05 | -5° | 轻微偏差 |
| 1000Hz | 1.67 | -15° | 显著偏差（PA6衰减） |

---

### 4️⃣ 校准完成

**成功标志：**
- 串口输出：`OK:CALIBRATION_COMPLETE`
- 前端显示：`✓ 校准完成！后续测量将自动应用校准修正`
- 状态指示：`✓ 校准已启用`（绿色脉冲）

**校准数据存储：**
- 保存在固件内存中（RAM）
- 断电或复位后失效
- 需要重新校准

---

### 5️⃣ 测量被测电路

**硬件重新连接：**
```
1. 移除PA6 → PB0短接线
2. 连接被测电路（DUT）：
   PA6 → [DUT输入]
   [DUT输出] → PB0
```

**开始测量：**
1. 点击 **"📊 开始扫描"** 按钮
2. 等待扫频完成
3. 查看校准后的结果

---

## 📊 结果显示

### 前端图表

校准后的图表会显示：

#### 幅频特性 H(ω)：
- **灰色虚线**：原始数据（未校准）
- **青色实线**：校准后数据（真实DUT特性）

#### 相频特性 θ(ω)：
- **浅红虚线**：原始数据
- **红色实线**：校准后数据

### 数据日志

```
数据 [已校准]: f=1000Hz, 
  H=1.85 (原始=3.08), 
  θ=-90° (原始=-118°)
```

---

## 🎯 校准效果对比

### 示例：测量两级运放电路

#### 未校准结果（错误）：
```
100Hz:  H = 2.30 (6.2 dB)
1000Hz: H = 3.00 (9.5 dB)  ← 虚假增益上升
```

#### 校准后结果（正确）：
```
100Hz:  H = 2.30 (6.2 dB)
1000Hz: H = 1.80 (5.1 dB)  ← 真实特性（高频衰减）
```

**结论**：校准修正了PA6基准信号的衰减，揭示了电路真实的频率响应。

---

## ⚙️ 技术细节

### 固件实现

**校准数据结构：**
```c
typedef struct {
    uint8_t valid;                           // 校准有效标志
    uint16_t gain_correction[100];           // 增益校正×10000
    int16_t phase_correction[100];           // 相位校正（度×100）
} CalibrationData_t;
```

**校准算法：**
```c
// 计算校准系数
H_measured = pp_ch2 / pp_ch1;  // 直通测试测得
gain_correction = 10000 / H_measured;  // 校正系数

phase_correction = -phase_measured;  // 相位补偿
```

**应用校准：**
```c
// 实际测量时
H_corrected = H_measured × gain_correction / 10000;
θ_corrected = θ_measured + phase_correction;
```

---

### 前端实现

**数据解析：**
```javascript
// 校准格式：freq,K,K1,H_raw,θ_raw,H_cal,θ_cal
if (parts.length >= 7) {
  H_calibrated = parseFloat(parts[5]);
  theta_calibrated = parseFloat(parts[6]);
  isCalibrated = true;
}
```

**图表显示：**
```javascript
datasets: hasCalibration ? [
  { label: 'H(ω) - 原始数据', borderDash: [5, 5] },
  { label: 'H(ω) - 智能处理后', borderWidth: 3 }
] : [...]
```

---

## ❓ 常见问题

### Q1: 校准数据会丢失吗？
**A:** 是的，校准数据存储在RAM中，断电或复位后会丢失。每次开机或更换电路后需要重新校准。

### Q2: 校准需要多长时间？
**A:** 约2-3分钟，取决于低频点的稳定时间。

### Q3: 直通测试时H不等于1.0正常吗？
**A:** 正常！这正是需要校准的原因。直通测试的偏差会被记录并在后续测量中补偿。

### Q4: 校准后图表反而变差了？
**A:** 可能的原因：
- 校准时连接有问题（接触不良）
- 校准时信号未稳定
- 建议重新校准

### Q5: 可以不校准直接测量吗？
**A:** 可以，但高频结果会不准确。如果只关注低频（<500Hz），可以不校准。

---

## 📝 最佳实践

### ✅ 推荐做法

1. **每次开机后校准**：确保基准一致
2. **更换被测电路后重新校准**：消除残留影响
3. **使用优质短线**：减少寄生效应
4. **等待稳定后测量**：低频需要更长时间

### ❌ 避免错误

1. ❌ 校准时被测电路未断开
2. ❌ 校准时连线过长或接触不良
3. ❌ 未等待校准完成就开始测量
4. ❌ 校准后忘记重新连接被测电路

---

## 🔬 验证校准效果

### 方法1：直通测试验证
```
校准后，再次PA6→PB0直通测试
预期：H≈1.0±0.05, θ≈0°±2°
```

### 方法2：已知电路验证
```
使用已知截止频率的RC滤波器
对比理论值和测量值
```

---

## 📞 技术支持

如遇到问题：
1. 检查硬件连接图（硬件连接图.txt）
2. 查看串口日志输出
3. 使用DEBUG命令检查系统状态

---

**更新日期**：2025-10-31  
**版本**：v1.0（基于固件v5.0）

---

## 💡 总结

软件校准功能通过直通测试获取系统基准特性，然后在实际测量中自动补偿，解决了PA6信号源在高频衰减的问题，使得测量结果能够真实反映被测电路的频率响应特性。

**关键优势**：
- ✅ 无需修改硬件
- ✅ 自动应用修正
- ✅ 可视化对比显示
- ✅ 提高高频测量精度

**使用建议**：
- 对于高精度测量，建议每次测试前校准
- 对于快速测试，可以使用上次校准数据（重启前有效）












