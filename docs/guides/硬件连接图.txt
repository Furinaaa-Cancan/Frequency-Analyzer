═══════════════════════════════════════════════════════════════
    GD32F103 伯德图分析仪 硬件连接图 v5.0
    (Bode Plot Analyzer - DAC5311 Signal Generator + Frequency Response)
═══════════════════════════════════════════════════════════════


一、系统架构
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌───────────────────────────────────────────────────────────┐
│                    GD32F103 MCU                            │
│                                                            │
│  ┌──────────────┐                                         │
│  │   DDS算法    │                                         │
│  │  (50kHz采样) │                                         │
│  └──────┬───────┘                                         │
│         │                                                  │
│         ↓                                                  │
│    ┌─────────┐        PA5 (SCLK)                         │
│    │  SPI1   ├────────────────────┐                      │
│    │         │        PA6 (DIN)   │                      │
│    │         ├────────────────────┤                      │
│    │         │        PA4 (SYNC)  │                      │
│    └─────────┴────────────────────┤                      │
│                                    │                      │
└────────────────────────────────────┼──────────────────────┘
                                     │
                              ┌──────▼──────┐
                              │   DAC5311   │
                              │  (外部DAC)  │
                              └──────┬──────┘
                                     │
                                     ↓
                              [运放滤波电路]
                                     │
                                     ↓
                                    PB1
                              (正弦波输出)
                              10Hz - 1kHz
                                     │
                    ┌────────────────┴────────────────┐
                    │                                  │
                   ↓                                  ↓
                  PA6                          [被测电路DUT]
              (ADC0_CH6)                               │
              输入参考K                                 │
              K·sin(ωt)                               ↓
                                                     PB1
                                                (ADC1_CH9)
                                                输出测量K₁
                                            K₁·sin(ωt+θ)


二、信号流程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. DDS波形生成（TIMER2，50kHz）
   └→ 8位正弦查找表（sine_table[256]）

2. SPI0传输到DAC5311
   └→ PA5 (SCLK), PA7 (MOSI/DIN), PA4 (CS/SYNC)

3. DAC5311输出 + 两级运放滤波
   └→ DAC5311 → U1A → U1B → PA6 模拟正弦波（10Hz~1kHz）

4. 双路ADC同步采样（TIMER3触发，10kHz）
   ├→ PA6 (ADC0_CH6): 输入参考信号 K（来自U1B运放输出）
   └→ PB1 (ADC1_CH9): 输出反馈信号 K₁（来自被测电路DUT）

5. 频响计算
   ├→ 幅频特性: H(ω) = K₁/K
   └→ 相频特性: θ(ω) = arctan((Σsin·cos)/(Σcos²))


三、详细信号路径
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌──────────────────────────────────────────────────────────┐
│                    GD32F103                               │
│                                                           │
│    ┌─────────┐    50kHz                                  │
│    │ TIMER2  │───────→ 触发DDS采样                       │
│    └─────────┘                                           │
│                                                           │
│    ┌─────────┐                                           │
│    │   DDS   │ phase_accumulator += phase_increment      │
│    │  引擎   │ index = phase_acc >> 24                   │
│    │         │ sample = sine_table[index]                │
│    └────┬────┘                                           │
│         │ 8-bit sample                                   │
│         ↓                                                 │
│    ┌──────────┐                                          │
│    │   SPI0   │ PA5(SCLK), PA7(MOSI/DIN), PA4(SYNC)     │
│    └────┬─────┘                                          │
│         │                                                 │
└─────────┼─────────────────────────────────────────────────┘
          │ SPI数据
          ↓
   ┌─────────────┐
   │   DAC5311   │  外部12位DAC（U3芯片）
   │  (12-bit)   │  输入：8位DDS数据 << 4
   └──────┬──────┘
          │ 模拟输出
          ↓
   [U1A运放 → U1B运放 → 滤波]
          │
          ↓
         PA6 ──────┬──────────────────┐
   (ADC0_CH6参考)   │                  │
   输入信号K        │                  │
                   ↓                  ↓
                  [连接]         [被测电路DUT]
                                       │
                                       ↓
                                      PB1
                                (ADC1_CH9测量)
                                 输出信号K₁


四、引脚连接详细说明
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  引脚      功能              方向    连接目标              说明
  ─────    ──────────────    ────    ──────────────        ──────────────────
  PA5      SPI0_SCK          输出    DAC5311 SCK引脚       SPI时钟
  PA7      SPI0_MOSI(DIN)    输出    DAC5311 DIN引脚       SPI数据输出到DAC
  PA4      SPI0_CS(SYNC)     输出    DAC5311 SYNC引脚      SPI片选（低电平有效）
  
  (无)     DAC输出           模拟    U1A运放输入           DAC5311模拟输出
  (无)     U1A运放输出       模拟    U1B运放输入           第一级放大
  PA6      ADC0_CH6          输入    U1B运放输出           输入参考信号K (滤波后)
  
  PA6      ADC0_CH6          输入    跳线连接              输入参考信号K
  PB1      ADC1_CH9          输入    DUT输出               输出测量信号K₁
  
  PA9      USART0_TX         输出    PC/上位机             串口输出（115200波特率）
  PA10     USART0_RX         输入    PC/上位机             串口输入（115200波特率）


五、DAC5311连接示意图
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

    GD32F103                    DAC5311 (U3)
    ┌─────────┐                ┌──────────┐
    │   PA5   │───────────────→│   SCK    │
    │  (SCLK) │                │          │
    │   PA6   │───────────────→│   DIN    │
    │  (DIN)  │                │          │
    │   PA4   │───────────────→│   SYNC   │
    │ (SYNC)  │                │          │
    │         │                │   VOUT   │────→ [运放滤波] ────→ PB1
    │         │                │          │
    │   GND   │───────────────→│   GND    │
    │   3.3V  │───────────────→│   VDD    │
    └─────────┘                └──────────┘


六、被测电路（DUT）连接示例
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

示例1：直通测试（验证系统正常工作）
    PA6 ─────────────────────→ PB1
    期望结果：H(ω) ≈ 1.0, θ(ω) ≈ 0°

示例2：RC低通滤波器
    PA6 ──[R]──┬──> PB1
               │
              [C]
               │
              GND
    期望结果：
    - 低频：H ≈ 1.0, θ ≈ 0°
    - 截止频率fc = 1/(2πRC)：H ≈ 0.707 (-3dB), θ ≈ -45°
    - 高频：H << 1.0, θ → -90°

示例3：RC高通滤波器
    PA6 ──[C]──┬──> PB1
               │
              [R]
               │
              GND
    期望结果：
    - 低频：H << 1.0, θ → +90°
    - 截止频率fc：H ≈ 0.707 (-3dB), θ ≈ +45°
    - 高频：H ≈ 1.0, θ ≈ 0°


七、完整测量流程
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 通过UART设置测试频率
   命令：FREQ:100  (设置为100Hz)

2. MCU生成DDS正弦波 → SPI0 → DAC5311 → U1A → U1B → PA6输出

3. 信号分为两路：
   路径1：PA6 直接连接或跳线（ADC0采样输入信号K）
   路径2：PA6 → [DUT] → PB1 (ADC1采样输出信号K₁)

4. ADC同步采样（10kHz），采集256个样本
   t[i] = i / 10000 (采样时间)

5. 计算频响特性
   5.1 计算参考信号的sin和cos分量：
       sin_ref = Σ K[i] · sin(2π·f·t[i])
       cos_ref = Σ K[i] · cos(2π·f·t[i])
       K_mag = sqrt(sin_ref² + cos_ref²)

   5.2 计算输出信号的sin和cos分量：
       sin_out = Σ K₁[i] · sin(2π·f·t[i])
       cos_out = Σ K₁[i] · cos(2π·f·t[i])
       K1_mag = sqrt(sin_out² + cos_out²)

   5.3 计算幅频特性（增益）：
       H(ω) = K1_mag / K_mag

   5.4 计算相频特性（相位差）：
       θ₁ = atan2(sin_out, cos_out)
       θ_ref = atan2(sin_ref, cos_ref)
       θ(ω) = θ₁ - θ_ref

6. 通过UART发送结果到PC
   格式：RESULT:freq,H_dB,phase_deg

7. 自动扫频（可选）
   命令：SWEEP
   自动测试10Hz - 1000Hz（步进10Hz）


八、典型应用场景
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. 模拟滤波器频响测试
   - RC/LC低通/高通/带通滤波器
   - 多级滤波器级联特性

2. 运放电路频率响应
   - 增益带宽积测试
   - 相位裕度测量

3. 传感器频率特性
   - 加速度计/麦克风频响
   - 压电传感器特性

4. 音频功放测试
   - 频率响应平坦度
   - 相位失真分析

5. 教学实验
   - 信号与系统课程
   - 电路原理实验


九、关键参数
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  参数                  数值                  说明
  ──────────────────  ─────────────────    ──────────────────
  DDS采样率            50 kHz               TIMER2中断频率
  DDS分辨率            8 bit (256级)        正弦查找表大小
  DAC位数              12 bit (4096级)      DAC5311分辨率
  输出频率范围         10 Hz - 1 kHz        可调节，步进10Hz
  ADC采样率            10 kHz               TIMER3触发频率
  ADC采样点数          256                  每次测量采样数
  ADC分辨率            12 bit               ADC0/ADC1精度
  串口波特率           115200               USART0通信速率
  
  理论THD              < 1%                 总谐波失真
  幅频测量精度         ±0.1 dB              信号增益测量误差
  相频测量精度         ±2°                  相位测量误差


十、软件命令集
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  命令           参数            功能                    示例
  ────────────  ─────────────  ───────────────────    ─────────────
  FREQ:<hz>     10-1000         设置测试频率            FREQ:100
  START         无              启动DDS输出             START
  STOP          无              停止DDS输出             STOP
  MEASURE       无              立即测量一次H(ω)和θ(ω) MEASURE
  SWEEP         无              自动扫频10Hz-1kHz       SWEEP
  STATUS        无              查询系统状态            STATUS
  DEBUG         无              显示调试信息            DEBUG
  HELP          无              显示帮助信息            HELP


十一、注意事项
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. DAC5311电源
   ✓ VDD = 3.3V（与MCU同电源）
   ✓ 去耦电容：靠近芯片放置100nF陶瓷电容

2. SPI通信
   ✓ 使用硬件SPI0：PA5(SCK), PA7(MOSI), PA4(CS)
   ✓ PA4 (SYNC/CS) 低电平有效，默认应保持高电平
   ✓ SPI模式：Mode 0 (CPOL=0, CPHA=0)
   ✓ 速度：2.25MHz (72MHz/32分频)

3. 信号完整性
   ✓ 信号已经过U1A和U1B两级运放滤波
   ✓ 避免PA6/PB1引线过长，减少干扰
   ✓ 共地设计，减少地环路
   ✓ PA7用于SPI通信，不要连接其他信号

4. 测量精度
   ✓ DUT输入阻抗应 >> 运放输出阻抗
   ✓ 保持PA6和PB1等长连接，减少相位误差
   ✓ 避免信号过载（ADC输入范围：0-3.3V）
   ✓ 使用改进的DFT算法，相位精度±1°

5. 频率限制
   ✓ 最低频率10Hz（受ADC采样窗口限制）
   ✓ 最高频率1kHz（奈奎斯特定理：fs/2 = 5kHz）

6. 校准建议
   ✓ 使用直通连接测试（PA6→PB1），确认H≈1.0, θ≈0°
   ✓ 使用已知RC电路验证截止频率测量准确性
   ✓ 低频测试（10-20Hz）确认相位连续性


十二、故障排查
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

问题：PA6无输出信号
  → 检查DAC5311电源（VDD = 3.3V）
  → 检查SPI连线（PA5/PA7/PA4，注意是PA7不是PA6！）
  → 检查运放U1A和U1B的电源
  → 用DEBUG命令确认TIMER2中断正常运行

问题：H(ω) 异常大或异常小
  → 检查ADC参考电压（VREF+ = 3.3V）
  → 检查信号幅度是否在0-3.3V范围
  → 用STATUS命令确认频率设置正确

问题：相位θ(ω) 跳变
  → v5.4版本已修复：使用DFT算法替代过零点检测
  → 检查PA6和PB1连线等长性
  → 低频（<20Hz）已自动增加测量次数
  → 如仍有跳变，检查信号是否太弱或有干扰

问题：串口无数据
  → 检查波特率设置（115200, 8N1）
  → 检查PA9/PA10连接（TX/RX不要接反）
  → 用DEBUG命令确认系统运行状态


═══════════════════════════════════════════════════════════════
  文档版本: v5.4 (2025-10-24)
  最后修改: 
    - 修正引脚描述：SPI0使用PA5/PA7/PA4
    - ADC采样PA6(CH6)和PB1(CH9)
    - 改进相位算法：DFT替代过零点检测
    - 自适应采样策略：低频增加测量次数
═══════════════════════════════════════════════════════════════
