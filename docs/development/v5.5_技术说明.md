# ğŸ”¬ v5.5æŠ€æœ¯è¯´æ˜ - DFTç›¸ä½æµ‹é‡ç®—æ³•

> **æŠ€æœ¯æ–‡æ¡£ - ç”¨äºæ·±å…¥ç†è§£ç®—æ³•å®ç°**

---

## ğŸ“‹ ç‰ˆæœ¬æ¼”è¿›

### v5.0-v5.3: è¿‡é›¶ç‚¹æ£€æµ‹æ³•
```c
// ç®€å•ä½†ä¸å‡†ç¡®
if(signal[i-1] < dc && signal[i] >= dc)
    zero_cross = i;
phase_diff = (zero_cross2 - zero_cross1) Ã— 360Â° / period;
```
**é—®é¢˜**: ç²¾åº¦ä½ï¼ˆÂ±10Â°ï¼‰ï¼Œä½é¢‘å®Œå…¨å¤±æ•ˆ

### v5.4: æ•´æ•°DFTï¼ˆå¤±è´¥ï¼‰
```c
// å¤æ‚çš„æ•´æ•°è¿ç®—
uint32_t phase_deg_x10 = (phase_x1000 * 573) / 1000;
// ... å¤šæ¬¡è½¬æ¢å’Œè¿‘ä¼¼
```
**é—®é¢˜**: å®ç°å¤æ‚ï¼Œå¼•å…¥å¤šä¸ªbugï¼Œç›¸ä½å¤±æ§

### v5.5: æµ®ç‚¹DFTï¼ˆæˆåŠŸï¼‰âœ…
```c
// ç®€å•å¯é 
float omega = 2.0f * PI * freq / sample_rate;
float sin_sum = Î£ signal[i] Ã— sin(omega Ã— i);
float cos_sum = Î£ signal[i] Ã— cos(omega Ã— i);
float phase = atan2f(sin_sum, cos_sum);
```
**ä¼˜åŠ¿**: ç®€å•ã€ç²¾ç¡®ã€å¯é 

---

## ğŸ¯ DFTç›¸ä½æµ‹é‡åŸç†

### æ•°å­¦åŸºç¡€

å¯¹äºæ­£å¼¦ä¿¡å· `x(t) = AÂ·sin(Ï‰t + Ï†)`ï¼Œåœ¨é¢‘ç‡Ï‰å¤„çš„DFTä¸ºï¼š

```
X(Ï‰) = Î£ x[n] Â· e^(-jÏ‰n)
     = Î£ x[n] Â· (cos(Ï‰n) - jÂ·sin(Ï‰n))
     
å®éƒ¨: Re = Î£ x[n] Â· cos(Ï‰n)
è™šéƒ¨: Im = Î£ x[n] Â· sin(Ï‰n)

ç›¸ä½: Ï† = atan2(Im, Re)
```

### ç®—æ³•å®ç°

```c
int32_t EstimatePhaseShift_Int(uint16_t *signal1, uint16_t *signal2, 
                                uint32_t count, uint32_t sample_rate, 
                                uint32_t signal_freq)
{
    /* 1. å»ç›´æµåç§» */
    uint16_t dc1 = CalculateDCOffset(signal1, count);
    uint16_t dc2 = CalculateDCOffset(signal2, count);
    
    /* 2. DFTç´¯åŠ å™¨ */
    float sin_sum1 = 0.0f, cos_sum1 = 0.0f;
    float sin_sum2 = 0.0f, cos_sum2 = 0.0f;
    
    /* 3. è®¡ç®—è§’é¢‘ç‡ */
    float omega = 2.0f * PI * signal_freq / (float)sample_rate;
    
    /* 4. å•é¢‘ç‚¹DFT */
    for(uint32_t i = 0; i < count; i++)
    {
        float val1 = (float)((int32_t)signal1[i] - (int32_t)dc1);
        float val2 = (float)((int32_t)signal2[i] - (int32_t)dc2);
        
        float phase = omega * i;
        float sin_val = sinf(phase);
        float cos_val = cosf(phase);
        
        sin_sum1 += val1 * sin_val;
        cos_sum1 += val1 * cos_val;
        sin_sum2 += val2 * sin_val;
        cos_sum2 += val2 * cos_val;
    }
    
    /* 5. è®¡ç®—ç›¸ä½ï¼ˆå¼§åº¦ï¼‰ */
    float phase1_rad = atan2f(sin_sum1, cos_sum1);
    float phase2_rad = atan2f(sin_sum2, cos_sum2);
    
    /* 6. ç›¸ä½å·® */
    float phase_diff_rad = phase2_rad - phase1_rad;
    
    /* 7. è½¬æ¢ä¸ºåº¦Ã—100 */
    float phase_diff_deg = phase_diff_rad * 18000.0f / PI;
    
    /* 8. å½’ä¸€åŒ–åˆ°Â±180Â° */
    while(phase_diff_deg > 18000.0f) phase_diff_deg -= 36000.0f;
    while(phase_diff_deg < -18000.0f) phase_diff_deg += 36000.0f;
    
    return (int32_t)phase_diff_deg;
}
```

---

## ğŸ”„ ç›¸ä½Unwrappingç®—æ³•

### é—®é¢˜æè¿°

atan2fè¿”å›å€¼èŒƒå›´ï¼š**-Ï€ ~ +Ï€ (-180Â° ~ +180Â°)**

å¯¹äºè¿ç»­å˜åŒ–çš„ç›¸ä½ï¼š
```
... -160Â°, -170Â°, +170Â° â† å›å·ï¼å®é™…åº”è¯¥æ˜¯-190Â°
```

### è§£å†³æ–¹æ¡ˆ

```c
// åœ¨AutoSweepå‡½æ•°ä¸­
int32_t phase_offset = 0;
int32_t last_phase_raw = 0;

for(freq = 10; freq <= 1000; freq += 10)
{
    // æµ‹é‡å½“å‰ç›¸ä½
    int32_t phase_raw = EstimatePhaseShift_Int(...);
    
    // æ£€æµ‹è·³å˜
    int32_t phase_diff = phase_raw - last_phase_raw;
    
    if(phase_diff > 18000)       // ä»è´Ÿè·³åˆ°æ­£ï¼ˆå®é™…åº”ç»§ç»­å‡å°ï¼‰
        phase_offset -= 36000;
    else if(phase_diff < -18000) // ä»æ­£è·³åˆ°è´Ÿï¼ˆå®é™…åº”ç»§ç»­å¢å¤§ï¼‰
        phase_offset += 36000;
    
    // åº”ç”¨è¡¥å¿
    int32_t phase_unwrapped = phase_raw + phase_offset;
    
    last_phase_raw = phase_raw;
}
```

### æ•ˆæœå¯¹æ¯”

**Before (æ— unwrapping)**:
```
-160Â°, -170Â°, +170Â°, +160Â°, -175Â° â† å‰§çƒˆè·³å˜ï¼
```

**After (æœ‰unwrapping)**:
```
-160Â°, -170Â°, -190Â°, -200Â°, -185Â° â† å¹³æ»‘è¿ç»­
```

---

## âš¡ æ€§èƒ½åˆ†æ

### è®¡ç®—å¤æ‚åº¦

```
å•æ¬¡ç›¸ä½æµ‹é‡:
  - DFTå¾ªç¯: 512æ¬¡ Ã— (2ä¸ªsin + 2ä¸ªcos + 4ä¸ªä¹˜æ³•) â‰ˆ 4Kæ¬¡æµ®ç‚¹è¿ç®—
  - atan2f: 2æ¬¡
  - æ€»æ—¶é—´: <1ms @ 72MHz
```

### å†…å­˜å ç”¨

```c
static uint16_t adc0_data[512];  // 1KB
static uint16_t adc1_data[512];  // 1KB
float sin_sum, cos_sum;          // 16å­—èŠ‚
æ€»è®¡: ~2KB
```

### ç²¾åº¦åˆ†æ

| æ–¹æ³• | ç²¾åº¦ | ä½é¢‘è¡¨ç° | æŠ—å™ªå£° |
|------|------|---------|--------|
| **è¿‡é›¶ç‚¹æ£€æµ‹** | Â±10Â° | å¤±æ•ˆ | å·® |
| **æ•´æ•°DFT** | Â±5Â° | è¾ƒå¥½ | ä¸€èˆ¬ |
| **æµ®ç‚¹DFT** | **Â±1Â°** | **ä¼˜ç§€** | **ä¼˜ç§€** |

---

## ğŸ¨ è‡ªé€‚åº”é‡‡æ ·ç­–ç•¥

```c
// æ ¹æ®é¢‘ç‡è°ƒæ•´æµ‹é‡æ¬¡æ•°
uint8_t measurement_count;
if(freq <= 20)
    measurement_count = 3;  // æä½é¢‘ï¼š3æ¬¡å¹³å‡
else if(freq <= 50)
    measurement_count = 2;  // ä½é¢‘ï¼š2æ¬¡å¹³å‡
else
    measurement_count = 1;  // ä¸­é«˜é¢‘ï¼šå•æ¬¡

// ç¨³å®šæ—¶é—´
uint32_t settle_time_ms;
if(freq <= 20)
    settle_time_ms = (15000 / freq) + 200;  // 15ä¸ªå‘¨æœŸ
else if(freq <= 50)
    settle_time_ms = (10000 / freq) + 100;  // 10ä¸ªå‘¨æœŸ
else
    settle_time_ms = (5000 / freq) + 50;    // 5ä¸ªå‘¨æœŸ
```

**åŸå› **ï¼š
- ä½é¢‘ä¿¡å·å‘¨æœŸé•¿ï¼Œéœ€è¦æ›´å¤šé‡‡æ ·ç‚¹
- å¤šæ¬¡æµ‹é‡å¹³å‡å¯ä»¥é™ä½éšæœºè¯¯å·®
- é«˜é¢‘ä¿¡å·ç¨³å®šå¿«ï¼Œå•æ¬¡æµ‹é‡å³å¯

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸ç”¨æ•´æ•°è¿ç®—ï¼Ÿ
**A**: 
- æ•´æ•°DFTéœ€è¦å¤æ‚çš„è½¬æ¢å’Œè¿‘ä¼¼
- å®¹æ˜“å¼•å…¥bugï¼ˆv5.4çš„æ•™è®­ï¼‰
- ARM Cortex-M3æµ®ç‚¹æ€§èƒ½è¶³å¤Ÿ
- **æ­£ç¡®æ€§ > æ€§èƒ½ä¼˜åŒ–**

### Q2: sinf/cosfé€Ÿåº¦æ…¢æ€ä¹ˆåŠï¼Ÿ
**A**:
- 72MHz MCUï¼Œ512ç‚¹DFT < 1ms
- å¯¹äº2åˆ†é’Ÿçš„æ€»æ‰«ææ—¶é—´ï¼Œå¯å¿½ç•¥
- å¦‚éœ€ä¼˜åŒ–ï¼Œå¯ç”¨æŸ¥è¡¨æ³•

### Q3: ä¸ºä»€ä¹ˆç”¨512ä¸ªé‡‡æ ·ç‚¹ï¼Ÿ
**A**:
- 10Hzä¿¡å·åœ¨10kHzé‡‡æ ·ç‡ä¸‹ï¼š
  - 1ä¸ªå‘¨æœŸ = 1000ä¸ªç‚¹
  - 512ä¸ªç‚¹ = 0.5ä¸ªå‘¨æœŸï¼ˆåˆšå¥½å¤Ÿï¼‰
- 1000Hzä¿¡å·ï¼š512ä¸ªç‚¹ = 51ä¸ªå‘¨æœŸï¼ˆéå¸¸å……è¶³ï¼‰
- å¹³è¡¡ä½é¢‘å’Œé«˜é¢‘çš„éœ€æ±‚

---

## ğŸ“Š å®æµ‹æ•°æ®éªŒè¯

### æµ‹è¯•æ¡ä»¶
- ç›´é€šè¿æ¥: PA6 â†’ PB0
- é¢‘ç‡: 100Hz
- é‡‡æ ·: 512ç‚¹ @ 10kHz

### ç†è®ºå€¼
```
phase_diff = 0Â°ï¼ˆç›´é€šæ— ç›¸ç§»ï¼‰
```

### å®æµ‹å€¼
```
v5.3 (è¿‡é›¶ç‚¹): -12Â° Â± 8Â°  âŒ è¯¯å·®å¤§
v5.4 (æ•´æ•°DFT): -5Â° Â± 15Â° âŒ ä¸ç¨³å®š  
v5.5 (æµ®ç‚¹DFT): -0.8Â° Â± 1Â° âœ… ç²¾ç¡®ï¼
```

---

## ğŸ’¡ ç»éªŒæ•™è®­

### 1. ç®€å•å°±æ˜¯ç¾
- v5.4å°è¯•ä¼˜åŒ–æ€§èƒ½ï¼Œå†™äº†200è¡Œå¤æ‚æ•´æ•°è¿ç®—
- ç»“æœbugç™¾å‡ºï¼Œç›¸ä½å¤±æ§
- v5.5å›å½’ç®€å•çš„æµ®ç‚¹å®ç°ï¼Œ50è¡Œä»£ç æå®š

### 2. ä¸è¦è¿‡æ—©ä¼˜åŒ–
- å…ˆä¿è¯æ­£ç¡®æ€§
- ç¡®è®¤æœ‰æ€§èƒ½ç“¶é¢ˆå†ä¼˜åŒ–
- æµ‹é‡ä¼˜åŒ–æ•ˆæœ

### 3. ä½¿ç”¨æ ‡å‡†åº“
- sinf, cosf, atan2féƒ½æ˜¯ç»è¿‡å……åˆ†æµ‹è¯•çš„
- è‡ªå·±å®ç°å®¹æ˜“å‡ºé”™
- æ ‡å‡†åº“æ€§èƒ½å·²ç»è¶³å¤Ÿå¥½

---

## ğŸ¯ æ€»ç»“

v5.5çš„æˆåŠŸå…³é”®åœ¨äºï¼š

1. âœ… **ç®—æ³•æ­£ç¡®**: DFTæ–¹æ³•ç†è®ºå¯é 
2. âœ… **å®ç°ç®€å•**: ä½¿ç”¨æ ‡å‡†åº“ï¼Œé¿å…å¤æ‚è½¬æ¢
3. âœ… **å……åˆ†æµ‹è¯•**: ç›´é€šæµ‹è¯•ã€RCæ»¤æ³¢å™¨æµ‹è¯•
4. âœ… **æŒç»­ä¼˜åŒ–**: ä»v5.0åˆ°v5.5çš„è¿­ä»£è¿‡ç¨‹

**æœ€ç»ˆç»“æœ**: ç›¸ä½æµ‹é‡ç²¾åº¦Â±1Â°ï¼Œå®Œå…¨æ»¡è¶³è¯¾ç¨‹è¦æ±‚ï¼ğŸ‰

---

**æŠ€æœ¯æ”¯æŒ**: leeyoung7017@163.com















