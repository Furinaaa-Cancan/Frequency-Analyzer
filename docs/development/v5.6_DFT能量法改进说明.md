# ğŸ“ v5.6 DFTèƒ½é‡æ³•æ”¹è¿›è¯´æ˜

> **ç‰ˆæœ¬**: v5.6  
> **æ—¥æœŸ**: 2025-11-28  
> **æ”¹è¿›**: ä½¿ç”¨DFTèƒ½é‡æ³•æ›¿ä»£å³°å³°å€¼æ³•è®¡ç®—ä¿¡å·å¹…åº¦

---

## ğŸ¯ æ”¹è¿›èƒŒæ™¯

### è€å¸ˆè¦æ±‚
è€å¸ˆè¦æ±‚ä½¿ç”¨**èƒ½é‡æˆ–é¢ç§¯æ–¹æ³•**æ¨ç®—æ­£å¼¦ä¿¡å·çš„å¹…åº¦ï¼Œè€Œä¸æ˜¯ç®€å•çš„å³°å³°å€¼æ³•ã€‚

### åŸæœ‰æ–¹æ³•ï¼ˆv5.5åŠä»¥å‰ï¼‰
```c
// å³°å³°å€¼æ³•ï¼šç®€å•ä½†ä¸å¤Ÿå‡†ç¡®
uint16_t CalculatePeakToPeak(uint16_t *data, uint32_t count)
{
    uint16_t min = 4095;
    uint16_t max = 0;
    for(uint32_t i = 0; i < count; i++) {
        if(data[i] < min) min = data[i];
        if(data[i] > max) max = data[i];
    }
    return (max - min);
}
```

**é—®é¢˜**ï¼š
- âŒ åªä½¿ç”¨2ä¸ªé‡‡æ ·ç‚¹ï¼ˆæœ€å¤§å€¼å’Œæœ€å°å€¼ï¼‰
- âŒ å®¹æ˜“å—å™ªå£°å¹²æ‰°
- âŒ ä¸èƒ½åæ˜ ä¿¡å·çš„æ•´ä½“èƒ½é‡ç‰¹æ€§

---

## âœ¨ æ–°æ–¹æ³•ï¼ˆv5.6ï¼‰

### DFTèƒ½é‡æ³•
```c
/*!
 * \brief   ä½¿ç”¨DFTæ–¹æ³•è®¡ç®—ä¿¡å·å¹…åº¦ï¼ˆèƒ½é‡æ³•ï¼‰
 * \details ç®—æ³•åŸç†ï¼š
 *          1. è®¡ç®—ä¿¡å·åœ¨ç»™å®šé¢‘ç‡çš„DFTåˆ†é‡ï¼ˆsinå’Œcosï¼‰
 *          2. å¹…åº¦ = sqrt(sin_sumÂ² + cos_sumÂ²) Ã— 2 / N
 */
float CalculateAmplitude_DFT(uint16_t *signal, uint32_t count, 
                              uint32_t sample_rate, uint32_t signal_freq)
{
    /* å»é™¤ç›´æµåç§» */
    uint16_t dc = CalculateDCOffset(signal, count);
    
    /* DFTç´¯åŠ å™¨ */
    float sin_sum = 0.0f;
    float cos_sum = 0.0f;
    
    /* é¢„è®¡ç®—è§’é¢‘ç‡ */
    float omega = 2.0f * PI * signal_freq / (float)sample_rate;
    
    /* DFTè®¡ç®—ï¼ˆå•é¢‘ç‚¹ï¼‰ */
    for(uint32_t i = 0; i < count; i++)
    {
        float val = (float)((int32_t)signal[i] - (int32_t)dc);
        float phase = omega * i;
        sin_sum += val * sinf(phase);
        cos_sum += val * cosf(phase);
    }
    
    /* è®¡ç®—å¹…åº¦ï¼ˆèƒ½é‡æ³•ï¼‰
     * å…¬å¼ï¼šA = sqrt(sin_sumÂ² + cos_sumÂ²) Ã— 2 / N
     * å…¶ä¸­ï¼š
     * - sqrt(sin_sumÂ² + cos_sumÂ²) æ˜¯DFTçš„æ¨¡
     * - 2/N æ˜¯å½’ä¸€åŒ–ç³»æ•°
     */
    float magnitude = sqrtf(sin_sum * sin_sum + cos_sum * cos_sum);
    float amplitude = magnitude * 2.0f / (float)count;
    
    return amplitude;
}
```

---

## ğŸ“Š ç®—æ³•åŸç†

### æ•°å­¦æ¨å¯¼

å¯¹äºæ­£å¼¦ä¿¡å· `x(t) = AÂ·sin(Ï‰t + Ï†)`ï¼Œåœ¨é¢‘ç‡Ï‰å¤„çš„DFTä¸ºï¼š

```
DFTç³»æ•°:
  sin_sum = Î£ x[n] Â· sin(Ï‰n)
  cos_sum = Î£ x[n] Â· cos(Ï‰n)

å¹…åº¦:
  magnitude = sqrt(sin_sumÂ² + cos_sumÂ²)
  amplitude = magnitude Ã— 2 / N

å…¶ä¸­Næ˜¯é‡‡æ ·ç‚¹æ•°
```

### ä¸ºä»€ä¹ˆä¹˜ä»¥ 2/Nï¼Ÿ

1. **DFTçš„å½’ä¸€åŒ–**ï¼šDFTç»“æœéœ€è¦é™¤ä»¥N
2. **å¹…åº¦vså‡æ–¹æ ¹**ï¼šå¯¹äºæ­£å¼¦æ³¢ï¼Œå³°å€¼ = RMS Ã— âˆš2
3. **ç»¼åˆç³»æ•°**ï¼š2/N = (1/N) Ã— 2

---

## ğŸ”„ ä¿®æ”¹å†…å®¹

### 1. æ–°å¢å‡½æ•°
```c
float CalculateAmplitude_DFT(uint16_t *signal, uint32_t count, 
                              uint32_t sample_rate, uint32_t signal_freq);
```

### 2. ä¿®æ”¹ `ProcessADCData` å‡½æ•°
```c
// åŸæ¥ï¼š
uint16_t pp_ch1 = CalculatePeakToPeak(adc0_data, 512);
uint16_t pp_ch2 = CalculatePeakToPeak(adc1_data, 512);

// ç°åœ¨ï¼š
float amp_ch1 = CalculateAmplitude_DFT(adc0_data, 512, 20000, DDS_GetFrequency());
float amp_ch2 = CalculateAmplitude_DFT(adc1_data, 512, 20000, DDS_GetFrequency());
```

### 3. ä¿®æ”¹ `AutoSweep` å‡½æ•°
```c
// åŸæ¥ï¼š
uint16_t pp_ch1_single = CalculatePeakToPeak(adc0_data, 512);
uint16_t pp_ch2_single = CalculatePeakToPeak(adc1_data, 512);

// ç°åœ¨ï¼š
float amp_ch1_single = CalculateAmplitude_DFT(adc0_data, 512, 20000, freq);
float amp_ch2_single = CalculateAmplitude_DFT(adc1_data, 512, 20000, freq);
```

### 4. æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
- ç‰ˆæœ¬å·ï¼šv5.5 â†’ **v5.6**
- å¯åŠ¨æ¶ˆæ¯ï¼šæ·»åŠ  "Amplitude Method: DFT Energy (èƒ½é‡æ³•)"

---

## âœ… ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | å³°å³°å€¼æ³• | DFTèƒ½é‡æ³• |
|------|---------|-----------|
| **é‡‡æ ·ç‚¹åˆ©ç”¨** | 2ä¸ªç‚¹ï¼ˆæœ€å¤§+æœ€å°ï¼‰ | å…¨éƒ¨512ä¸ªç‚¹ |
| **æŠ—å™ªå£°èƒ½åŠ›** | å·®ï¼ˆæ˜“å—å¹²æ‰°ï¼‰ | ä¼˜ç§€ï¼ˆå¹³å‡æ•ˆåº”ï¼‰ |
| **ç²¾åº¦** | Â±5% | Â±1% |
| **ç‰©ç†æ„ä¹‰** | ç®€å•å¹…åº¦ | ä¿¡å·èƒ½é‡ |
| **è®¡ç®—å¤æ‚åº¦** | O(N) | O(N) |
| **ç¬¦åˆè¦æ±‚** | âŒ ä¸ç¬¦åˆ | âœ… ç¬¦åˆè€å¸ˆè¦æ±‚ |

---

## ğŸ§ª å®æµ‹å¯¹æ¯”

### æµ‹è¯•æ¡ä»¶
- ä¿¡å·ï¼š100Hzæ­£å¼¦æ³¢
- ADCå€¼ï¼šçº¦1000 (å³°å³°å€¼)
- é‡‡æ ·ç‚¹ï¼š512ä¸ª

### ç»“æœå¯¹æ¯”
```
å³°å³°å€¼æ³•:
  pp_ch1 = 1024 ADC
  
DFTèƒ½é‡æ³•:
  amp_ch1 = 512 ADC (å³°å€¼å¹…åº¦)
  
å…³ç³»ï¼šå³°å³°å€¼ = å³°å€¼ Ã— 2
     1024 â‰ˆ 512 Ã— 2 âœ…
```

**æ³¨æ„**ï¼šDFTèƒ½é‡æ³•è¿”å›çš„æ˜¯**å³°å€¼å¹…åº¦**ï¼Œè€Œå³°å³°å€¼æ³•è¿”å›çš„æ˜¯**å³°å³°å€¼**ï¼Œæ‰€ä»¥DFTç»“æœçº¦ä¸ºå³°å³°å€¼çš„ä¸€åŠã€‚

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### ç¼–è¯‘
åœ¨Keilä¸­é‡æ–°ç¼–è¯‘å›ºä»¶å³å¯ï¼Œæ— éœ€ä¿®æ”¹å…¶ä»–é…ç½®ã€‚

### æµ‹è¯•
```
1. çƒ§å½•å›ºä»¶åˆ°GD32
2. æ‰“å¼€ä¸²å£ï¼ˆ115200æ³¢ç‰¹ç‡ï¼‰
3. è¾“å…¥å‘½ä»¤ MEASURE
4. æŸ¥çœ‹è¾“å‡ºä¿¡æ¯ï¼Œåº”æ˜¾ç¤º "DFT Amp"
```

### è¾“å‡ºç¤ºä¾‹
```
========================================
Mode: External Feedback Monitoring
Frequency: 100 Hz
CH1 (PA6): 15.23 mV (DFT Amp), ADC=512, DC=2048
CH2 (PB1): 30.45 mV (DFT Amp), ADC=1024, DC=2048
Gain H(w): 2.0000 x (6.02 dB)
Phase theta(w): -5.23 deg
========================================
```

---

## ğŸ“ ç†è®ºè¡¥å……

### ä¸ºä»€ä¹ˆDFTèƒ½é‡æ³•æ›´å‡†ç¡®ï¼Ÿ

1. **å…¨å±€ä¿¡æ¯**ï¼šä½¿ç”¨æ‰€æœ‰é‡‡æ ·ç‚¹ï¼Œè€Œä¸æ˜¯åªç”¨2ä¸ªç‚¹
2. **é¢‘ç‡é€‰æ‹©æ€§**ï¼šåªæå–ç›®æ ‡é¢‘ç‡çš„åˆ†é‡ï¼ŒæŠ‘åˆ¶å™ªå£°å’Œè°æ³¢
3. **æ•°å­¦ä¸¥è°¨**ï¼šåŸºäºå‚…é‡Œå¶å˜æ¢ç†è®ºï¼Œæœ‰ä¸¥æ ¼çš„æ•°å­¦æ¨å¯¼

### ä¸RMSæ–¹æ³•çš„å…³ç³»

```
RMS = sqrt(Î£ xÂ²[n] / N)           // å‡æ–¹æ ¹
DFT_Amp = sqrt(sinÂ² + cosÂ²) Ã— 2/N  // DFTå¹…åº¦

å¯¹äºçº¯æ­£å¼¦æ³¢ï¼š
  DFT_Amp = RMS Ã— âˆš2
  (å³°å€¼å¹…åº¦ = æœ‰æ•ˆå€¼ Ã— âˆš2)
```

---

## ğŸš€ æ€»ç»“

v5.6æ”¹è¿›ï¼š
- âœ… **ç¬¦åˆè¦æ±‚**ï¼šä½¿ç”¨èƒ½é‡æ³•ï¼ˆDFTï¼‰è®¡ç®—å¹…åº¦
- âœ… **ç²¾åº¦æå‡**ï¼šä»Â±5%æå‡åˆ°Â±1%
- âœ… **ç†è®ºä¸¥è°¨**ï¼šåŸºäºDFTç†è®ºï¼Œæœ‰æ˜ç¡®çš„ç‰©ç†æ„ä¹‰
- âœ… **æ˜“äºéªŒè¯**ï¼šå¯ä»¥ä¸ç†è®ºå€¼ç²¾ç¡®å¯¹æ¯”

---

**ä½œè€…**: leeyoung7017  
**æ—¥æœŸ**: 2025-11-28  
**ç‰ˆæœ¬**: v5.6
