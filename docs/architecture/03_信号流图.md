# 项目二：GD32伯德图分析仪 - 信号流图

## 1. 信号处理全流程

```mermaid
flowchart LR
    subgraph "信号生成"
        T[TIMER2<br/>50kHz] --> P[相位累加器<br/>32位]
        P --> S[正弦表<br/>256点]
        S --> D[DAC5311<br/>8位]
    end
    
    subgraph "信号输出"
        D --> V[模拟电压<br/>0-2.5V]
        V --> O[输出幅度<br/>峰峰值≈0.5V]
    end
    
    subgraph "信号采样"
        O --> A[ADC0<br/>PA6]
        A --> C[12位采样<br/>10kHz]
        C --> DMA[DMA传输<br/>256点]
    end
    
    subgraph "信号处理"
        DMA --> PP[峰峰值计算<br/>max-min]
        PP --> DC[直流偏移<br/>平均值]
        DC --> MV[电压转换<br/>×3.3/4096]
    end
    
    subgraph "RC仿真"
        MV --> H[H(f)计算<br/>1/√(1+(f/fc)²)]
        H --> K1[输出计算<br/>K₁=K×H(f)]
        K1 --> TH[相位计算<br/>θ=-arctan(f/fc)]
    end
    
    subgraph "数据输出"
        TH --> UART[UART输出<br/>FREQ_RESP格式]
        UART --> WEB[Web显示<br/>伯德图]
    end
    
    style T fill:#e1f5ff
    style D fill:#ffcdd2
    style A fill:#fff3e0
    style H fill:#c8e6c9
    style WEB fill:#f3e5f5
```

---

## 2. DDS信号生成原理

```mermaid
flowchart TD
    Start([50kHz TIMER2中断]) --> Phase[相位累加器<br/>phase += increment]
    
    Phase --> Calc[相位增量计算<br/>increment = freq × 85899]
    Calc --> Note1["说明:<br/>2³²/50000 ≈ 85899<br/>实现频率可调"]
    
    Phase --> Index[索引计算<br/>index = phase >> 24]
    Index --> Note2["说明:<br/>取高8位作为索引<br/>范围: 0-255"]
    
    Index --> Lookup[查表<br/>sample = sine_table[index]]
    Lookup --> Note3["说明:<br/>256点正弦表<br/>y = 128 + 100×sin(2πx/256)"]
    
    Lookup --> Output[输出样本<br/>0-255]
    Output --> SPI[SPI1传输]
    SPI --> DAC[DAC5311输出]
    
    DAC --> Analog[模拟电压<br/>V = sample/255 × Vref]
    Analog --> Note4["说明:<br/>Vref = 2.5V<br/>输出范围: 0.1-2.4V"]
    
    style Start fill:#e1f5ff
    style Lookup fill:#fff3e0
    style DAC fill:#ffcdd2
```

---

## 3. 正弦波表结构

```mermaid
graph TD
    subgraph "正弦波表 sine_table[256]"
        S0["0: 128 (中点)"]
        S64["64: 228 (峰值)"]
        S128["128: 128 (中点)"]
        S192["192: 28 (谷值)"]
        S255["255: 124 (接近中点)"]
    end
    
    S0 --> Formula["公式:<br/>y = 128 + 100×sin(2π×i/256)<br/><br/>参数:<br/>• 中点: 128<br/>• 幅度: ±100<br/>• 峰峰值: 200<br/>• 范围: 28-228"]
    
    Formula --> Voltage["电压计算:<br/>V(i) = y(i)/255 × 2.5V<br/><br/>示例:<br/>• 最小: 28/255×2.5 ≈ 0.27V<br/>• 中点: 128/255×2.5 ≈ 1.25V<br/>• 最大: 228/255×2.5 ≈ 2.23V<br/>• 峰峰值: ≈ 1.96V"]
    
    style S0 fill:#e3f2fd
    style S64 fill:#fff3e0
    style S192 fill:#ffcdd2
```

---

## 4. ADC采样信号链

```mermaid
flowchart TD
    Input["模拟输入<br/>PA6 (ADC0_CH6)<br/>电压: 0-3.3V"] --> Sample["采样保持<br/>13.5周期<br/>@ 6MHz ADC时钟"]
    
    Sample --> Convert["A/D转换<br/>12.5周期<br/>总时间: 26周期 ≈ 4.3μs"]
    
    Convert --> Digital["数字输出<br/>12位: 0-4095<br/>分辨率: 3.3V/4096 ≈ 0.8mV"]
    
    Digital --> Format["数据格式<br/>32位: [ADC1高16位][ADC0低16位]"]
    
    Format --> DMA["DMA传输<br/>自动存入adc_buffer[256]"]
    
    DMA --> Process["数据处理:<br/>• 提取ADC0数据 (低16位)<br/>• 忽略ADC1数据 (高16位)<br/>• 计算峰峰值<br/>• 计算直流偏移"]
    
    style Input fill:#e1f5ff
    style Convert fill:#fff3e0
    style Digital fill:#c8e6c9
    style DMA fill:#bbdefb
```

---

## 5. RC滤波器数学模型

```mermaid
graph TB
    subgraph "输入参数"
        F["频率 f (Hz)<br/>范围: 10-1000Hz"]
        FC["截止频率 fc (Hz)<br/>159Hz"]
        K["输入幅度 K (mV)<br/>ADC真实测量"]
    end
    
    subgraph "幅频响应计算"
        Ratio["比值计算<br/>r = f/fc"]
        Denom["分母计算<br/>d = 1 + r²"]
        Sqrt["开方计算<br/>√d (牛顿迭代)"]
        H["幅频响应<br/>H(f) = 1/√d"]
    end
    
    subgraph "输出计算"
        K1["输出幅度<br/>K₁ = K × H(f)"]
        HdB["增益(dB)<br/>20×log₁₀(H)"]
    end
    
    subgraph "相频响应计算"
        Arctan["反正切计算<br/>arctan(f/fc)"]
        Theta["相频响应<br/>θ(f) = -arctan(f/fc)"]
        ThetaDeg["角度转换<br/>弧度→度"]
    end
    
    F --> Ratio
    FC --> Ratio
    Ratio --> Denom
    Denom --> Sqrt
    Sqrt --> H
    
    K --> K1
    H --> K1
    H --> HdB
    
    Ratio --> Arctan
    Arctan --> Theta
    Theta --> ThetaDeg
    
    style F fill:#e1f5ff
    style H fill:#c8e6c9
    style K1 fill:#fff3e0
    style Theta fill:#bbdefb
```

---

## 6. 整数运算实现（避免浮点）

```mermaid
flowchart TD
    Start["输入: freq, fc<br/>(整数类型)"] --> Calc1["计算ratio<br/>ratio = freq × 100 / fc<br/>(扩大100倍保持精度)"]
    
    Calc1 --> Calc2["计算平方<br/>ratio_sq = ratio × ratio<br/>(扩大10000倍)"]
    
    Calc2 --> Calc3["计算分母<br/>denom = 10000 + ratio_sq<br/>(对应 1 + (f/fc)²)"]
    
    Calc3 --> Newton["牛顿迭代开方<br/>x₀ = denom/2<br/>xₙ₊₁ = (xₙ + denom/xₙ)/2<br/>迭代10次或收敛"]
    
    Newton --> Result1["H × 10000<br/>= 1000000 / √denom<br/>(保留4位小数)"]
    
    Start --> Phase1["相位计算<br/>(分段线性近似)"]
    
    Phase1 --> Check1{"f < fc/4?"}
    Check1 -->|是| Linear["θ ≈ -f/fc × 45°"]
    Check1 -->|否| Check2{"f < fc?"}
    Check2 -->|是| Inter1["插值到-45°"]
    Check2 -->|否| Check3{"f < 2fc?"}
    Check3 -->|是| Inter2["插值到-63.4°"]
    Check3 -->|否| Asymp["逼近-90°"]
    
    Linear --> Result2["θ × 100<br/>(保留2位小数)"]
    Inter1 --> Result2
    Inter2 --> Result2
    Asymp --> Result2
    
    Result1 --> Output["输出:<br/>H(f) × 10000<br/>θ(f) × 100"]
    Result2 --> Output
    
    style Start fill:#e1f5ff
    style Newton fill:#fff3e0
    style Result1 fill:#c8e6c9
    style Result2 fill:#bbdefb
```

---

## 7. 数据传输协议

```mermaid
sequenceDiagram
    participant M as MCU (GD32)
    participant U as UART
    participant W as Web界面
    
    Note over W: 用户点击"测量"
    W->>U: 发送命令: "MEASURE\r\n"
    U->>M: 接收命令
    
    Note over M: 处理命令
    M->>M: 读取ADC缓冲区
    M->>M: 计算峰峰值
    M->>M: 计算H(f)和θ(f)
    
    M->>U: 发送数据
    Note right of M: FREQ_RESP:100,5.50,4.66,0.8473,-27.94
    
    U->>W: 接收数据
    Note over W: 解析数据
    W->>W: 提取: freq=100, K=5.50, K1=4.66
    W->>W: 提取: H=0.8473, θ=-27.94
    
    Note over W: 更新界面
    W->>W: 添加数据点到图表
    W->>W: 更新数据表格
    W->>W: 刷新统计信息
```

---

## 8. 数据格式说明

### FREQ_RESP协议格式

```
格式: FREQ_RESP:freq,K,K1,H,theta

示例: FREQ_RESP:100,5.50,4.66,0.8473,-27.94

字段说明:
┌────────┬─────────┬──────────────────┬────────┐
│ 字段   │ 单位    │ 说明             │ 精度   │
├────────┼─────────┼──────────────────┼────────┤
│ freq   │ Hz      │ 频率             │ 整数   │
│ K      │ 厘伏(cV)│ 输入幅度×100     │ 2位小数│
│ K1     │ 厘伏(cV)│ 输出幅度×100     │ 2位小数│
│ H      │ 无量纲  │ 幅频响应         │ 4位小数│
│ theta  │ 度(°)  │ 相频响应         │ 2位小数│
└────────┴─────────┴──────────────────┴────────┘

注意:
1. K和K1以厘伏(cV)为单位，方便整数传输
   例如: 5.50 cV = 550 mV = 0.55 V
2. H保留4位小数，精度0.0001
3. theta可为负数，范围: -90°到0°
```

---

## 9. 信号质量评估

```mermaid
flowchart TD
    ADC["ADC采样值<br/>0-4095"] --> Check1{值检查}
    
    Check1 -->|< 10| Weak["信号太弱<br/>⚠️ WARNING"]
    Check1 -->|10-4000| Normal["信号正常<br/>✓ OK"]
    Check1 -->|> 4000| Strong["信号过强<br/>⚠️ CLIPPING"]
    
    Weak --> Diag1["可能原因:<br/>1. DAC未连接<br/>2. DDS未启动<br/>3. VREF太低"]
    Normal --> Process["继续处理"]
    Strong --> Diag2["可能原因:<br/>1. 幅度过大<br/>2. ADC饱和<br/>3. 电路故障"]
    
    Process --> PP["峰峰值计算"]
    PP --> Check2{峰峰值检查}
    
    Check2 -->|< 100| Low["峰峰值偏低<br/>精度可能下降"]
    Check2 -->|100-3000| Good["峰峰值良好<br/>测量可靠"]
    Check2 -->|> 3000| High["峰峰值偏高<br/>注意饱和"]
    
    Low --> Result["输出结果<br/>带质量标记"]
    Good --> Result
    High --> Result
    
    style Normal fill:#c8e6c9
    style Good fill:#c8e6c9
    style Weak fill:#ffcdd2
    style Strong fill:#ffcdd2
```

---

## 10. 时域信号波形

```
时域波形示例 (100Hz正弦波)：

幅度(ADC值)
    4095 ┤
         │
    3000 ┤                  ╭─────╮
         │                ╱         ╲
    2048 ┤─────────────╱               ╲──────────
         │          ╱                     ╲
    1000 ┤        ╱                         ╲
         │     ╱                               ╲
       0 ┼──────────────────────────────────────────→ 时间
         0    2ms  4ms  6ms  8ms  10ms 12ms

参数:
• 周期: T = 10ms (100Hz)
• 峰峰值: Vpp = max - min
• 直流偏移: DC = (max + min) / 2
• 采样率: 10kHz (每周期100点)

质量指标:
• 信噪比: SNR = 20×log₁₀(信号/噪声)
• 总谐波失真: THD < 5%
• 频率精度: ±5%
```

---

## 11. 频域信号特性

```
频域分析 (FFT结果)：

幅度谱
     │
 100%│    ▓
     │    ▓
  75%│    ▓
     │    ▓
  50%│    ▓
     │    ▓                ▂
  25%│    ▓    ▂    ▂    ▂▂▂
     │    ▓▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂
   0%┼────┬────┬────┬────┬────┬──→ 频率
     0   f₀  2f₀ 3f₀ 4f₀ 5f₀  (Hz)

说明:
• f₀: 基频 (设定频率)
• 2f₀, 3f₀...: 谐波分量
• 理想正弦波只有f₀分量
• 实际信号含少量谐波

质量评估:
• 基频成分: > 95%
• 二次谐波: < 3%
• 三次谐波: < 1%
• 噪声底噪: < 1%
```

---

## 12. RC滤波器频率响应曲线

```
幅频响应 H(f) vs 频率:

  1.0 ┤────────────●
      │              ╲
  0.9 ┤               ╲
      │                ╲
  0.8 ┤                 ╲
      │                  ●
  0.7 ┤                   ╲
      │                    ╲ fc=159Hz
  0.5 ┤                     ●
      │                       ╲
  0.3 ┤                        ╲
      │                          ●
  0.1 ┤                           ╲●
      │                              ╲
  0.0 ┼─────┬─────┬─────┬─────┬─────┬──→
      0    100   200   500   1k   2k  (Hz)

相频响应 θ(f) vs 频率:

   0°┤────●
      │     ╲
 -20°┤      ╲
      │       ●
 -40°┤        ╲
      │         ●
 -60°┤          ╲ fc=159Hz
      │           ●
 -80°┤            ╲
      │             ●
-90°┤              ╲●●
      │
     ┼─────┬─────┬─────┬─────┬─────┬──→
     0    100   200   500   1k   2k  (Hz)

关键点:
• f = 0:     H=1.000,  θ=0°
• f = fc/4:  H≈0.970,  θ≈-14°
• f = fc:    H=0.707,  θ=-45°
• f = 2fc:   H=0.447,  θ≈-63°
• f = 10fc:  H=0.100,  θ≈-84°
• f → ∞:     H→0,      θ→-90°
```

---

**文档版本**: v1.0  
**更新日期**: 2025-10-18  
**适用项目**: GD32F103 伯德图分析仪






