# 项目二：GD32伯德图分析仪 - 系统流程图

## 1. 系统启动流程

```mermaid
flowchart TD
    Start([系统上电]) --> Init1[初始化UART0<br/>115200波特率]
    Init1 --> Init2[初始化DAC5311<br/>SPI1接口]
    Init2 --> Init3[初始化DDS模块<br/>默认100Hz]
    Init3 --> Init4[初始化TIMER2<br/>50kHz中断]
    Init4 --> Init5[启动DDS输出]
    Init5 --> Init6[初始化ADC DMA<br/>256点缓冲]
    Init6 --> Init7[初始化双ADC<br/>PA6/PA7]
    Init7 --> Init8[初始化TIMER3<br/>10kHz ADC触发]
    Init8 --> Init9[等待2秒<br/>信号稳定]
    Init9 --> Ready[系统就绪<br/>等待命令]
    
    Ready --> |UART命令| CmdLoop[命令处理循环]
    CmdLoop --> Ready
    
    style Start fill:#e1f5ff
    style Ready fill:#c8e6c9
    style Init5 fill:#fff9c4
```

---

## 2. DDS信号生成流程

```mermaid
flowchart TD
    Start([TIMER2中断<br/>50kHz]) --> Acc[相位累加器<br/>+=phase_increment]
    Acc --> Index[计算索引<br/>index=(phase>>24)&0xFF]
    Index --> Lookup[查表<br/>sample=sine_table[index]]
    Lookup --> SPI[SPI1发送<br/>DAC5311_Write]
    SPI --> CS1[CS拉低]
    CS1 --> Send[发送8位数据]
    Send --> CS2[CS拉高]
    CS2 --> DAC[DAC5311输出<br/>模拟电压]
    DAC --> End([中断返回])
    
    style Start fill:#e1f5ff
    style Lookup fill:#fff3e0
    style DAC fill:#ffcdd2
```

---

## 3. ADC采样流程

```mermaid
flowchart TD
    Start([TIMER3触发<br/>10kHz]) --> ADC1[ADC0采样PA6<br/>ADC1采样PA7]
    ADC1 --> Conv[同步转换<br/>13.5+12.5周期]
    Conv --> Merge[数据合并<br/>32位: ADC1高16位+ADC0低16位]
    Merge --> DMA[DMA传输<br/>到adc_buffer]
    DMA --> Check{缓冲区满?}
    Check --> |否| Next[继续采样]
    Check --> |是| Wrap[循环覆盖<br/>从头开始]
    Next --> End([等待下次触发])
    Wrap --> End
    
    style Start fill:#e1f5ff
    style ADC1 fill:#fff3e0
    style DMA fill:#c8e6c9
```

---

## 4. 数据处理流程

```mermaid
flowchart TD
    Start([接收到MEASURE命令]) --> Extract[提取ADC数据<br/>256点]
    Extract --> CalcPP[计算峰峰值<br/>找最大最小值]
    CalcPP --> Check{信号强度?}
    Check --> |<10| Error[输出错误提示<br/>检查连接]
    Check --> |10-4000| Normal[正常范围]
    Check --> |>4000| Warning[输出警告<br/>信号过强]
    
    Normal --> Voltage[转换电压<br/>mV=(ADC×3300)/4096]
    Warning --> Voltage
    
    Voltage --> GetFreq[获取当前频率]
    GetFreq --> CalcH[计算H(f)<br/>H=1/√(1+(f/fc)²)]
    CalcH --> CalcK1[计算输出<br/>K₁=K×H(f)]
    CalcK1 --> CalcTheta[计算相位<br/>θ=-arctan(f/fc)]
    CalcTheta --> CalcDC[计算直流偏移]
    CalcDC --> Output[输出结果<br/>FREQ_RESP格式]
    Output --> End([完成])
    
    Error --> End
    
    style Start fill:#e1f5ff
    style Check fill:#fff9c4
    style CalcH fill:#c8e6c9
    style Output fill:#bbdefb
```

---

## 5. 自动扫频流程

```mermaid
flowchart TD
    Start([接收到SWEEP命令]) --> Print1[输出扫频开始信息]
    Print1 --> Init[频率=10Hz]
    Init --> Loop{freq≤1000?}
    
    Loop --> |是| SetFreq[设置频率<br/>DDS_SetFrequency]
    SetFreq --> Wait[等待稳定<br/>3个周期+50ms]
    Wait --> Sample[采集ADC数据<br/>256点]
    Sample --> Process[数据处理<br/>计算H和θ]
    Process --> Check{信号有效?}
    
    Check --> |是| Valid[输出数据<br/>FREQ_RESP:...]
    Check --> |否| Invalid[输出默认值<br/>0.00,0.00,...]
    
    Valid --> Progress{freq%100==0?}
    Invalid --> Progress
    
    Progress --> |是| ShowProgress[显示进度<br/>xx/1000Hz]
    Progress --> |否| NextFreq
    ShowProgress --> NextFreq[频率+=10Hz]
    NextFreq --> Loop
    
    Loop --> |否| Print2[输出扫频完成]
    Print2 --> Restore[恢复频率100Hz]
    Restore --> End([完成])
    
    style Start fill:#e1f5ff
    style Process fill:#fff3e0
    style Valid fill:#c8e6c9
```

---

## 6. UART命令处理流程

```mermaid
flowchart TD
    Start([接收字符]) --> Echo[回显字符]
    Echo --> Check{是回车/换行?}
    
    Check --> |否| Buffer[存入缓冲区]
    Buffer --> Full{缓冲区满?}
    Full --> |是| Overflow[输出溢出警告<br/>复位缓冲区]
    Full --> |否| Wait[继续接收]
    Overflow --> Wait
    Wait --> Start
    
    Check --> |是| Parse[解析命令]
    
    Parse --> CMD1{FREQ:xxx?}
    CMD1 --> |是| SetFreq[设置频率]
    CMD1 --> |否| CMD2{MEASURE?}
    
    CMD2 --> |是| Measure[单次测量]
    CMD2 --> |否| CMD3{SWEEP?}
    
    CMD3 --> |是| Sweep[自动扫频]
    CMD3 --> |否| CMD4{DEBUG?}
    
    CMD4 --> |是| Debug[输出调试信息]
    CMD4 --> |否| CMD5{STATUS?}
    
    CMD5 --> |是| Status[查询状态]
    CMD5 --> |否| CMD6{HELP?}
    
    CMD6 --> |是| Help[显示帮助]
    CMD6 --> |否| Unknown[未知命令]
    
    SetFreq --> Reset[清空缓冲区]
    Measure --> Reset
    Sweep --> Reset
    Debug --> Reset
    Status --> Reset
    Help --> Reset
    Unknown --> Reset
    
    Reset --> End([等待下一条命令])
    
    style Start fill:#e1f5ff
    style Parse fill:#fff3e0
    style Measure fill:#c8e6c9
    style Sweep fill:#bbdefb
```

---

## 7. Web界面交互流程

```mermaid
flowchart TD
    Start([用户打开网页]) --> Load[加载React应用]
    Load --> Check{支持Web Serial?}
    
    Check --> |否| Error[显示错误提示<br/>请使用Chrome]
    Check --> |是| Ready[显示连接按钮]
    
    Ready --> Click[用户点击连接]
    Click --> SelectPort[选择串口设备]
    SelectPort --> Open[打开串口<br/>115200波特率]
    Open --> Success{连接成功?}
    
    Success --> |否| ShowError[显示错误信息]
    Success --> |是| Connected[显示已连接状态]
    
    Connected --> ReadLoop[开始读取数据循环]
    
    ReadLoop --> Receive[接收串口数据]
    Receive --> Parse[解析数据行]
    Parse --> Match{匹配FREQ_RESP?}
    
    Match --> |是| Extract[提取数据<br/>freq,K,K1,H,theta]
    Match --> |否| Log[添加到日志窗口]
    
    Extract --> Validate{数据验证}
    Validate --> |通过| AddPoint[添加数据点<br/>按频率排序]
    Validate --> |失败| LogWarn[记录警告]
    
    AddPoint --> Update[更新图表<br/>Chart.js]
    Update --> Table[更新数据表格]
    Table --> Stats[更新统计信息]
    
    LogWarn --> ReadLoop
    Log --> ReadLoop
    Stats --> ReadLoop
    
    Connected --> |用户操作| UserCmd[发送命令]
    UserCmd --> SendUART[通过串口发送]
    SendUART --> ReadLoop
    
    style Start fill:#e1f5ff
    style Connected fill:#c8e6c9
    style Update fill:#fff3e0
```

---

## 8. RC滤波仿真计算流程

```mermaid
flowchart TD
    Start([输入: freq, fc]) --> CalcRatio[计算比值<br/>ratio=freq×100/fc]
    CalcRatio --> Square[计算平方<br/>ratio_sq=ratio²]
    Square --> Denom[计算分母<br/>denom=10000+ratio_sq]
    
    Denom --> InitX[初始化x=denom/2]
    InitX --> Loop{迭代10次}
    
    Loop --> |继续| Newton[牛顿迭代<br/>x_new=(x+denom/x)/2]
    Newton --> Converge{x_new==x?}
    Converge --> |是| Break[提前退出]
    Converge --> |否| Update[x=x_new]
    Update --> Loop
    
    Loop --> |完成| CalcH[计算H<br/>H=1000000/x]
    Break --> CalcH
    
    CalcH --> Phase1{freq<fc/4?}
    Phase1 --> |是| Linear[线性近似<br/>θ≈-f/fc×45°]
    Phase1 --> |否| Phase2{freq<fc?}
    
    Phase2 --> |是| Inter1[插值计算<br/>到-45°]
    Phase2 --> |否| Phase3{freq<2fc?}
    
    Phase3 --> |是| Inter2[插值计算<br/>到-63.4°]
    Phase3 --> |否| Phase4{freq<4fc?}
    
    Phase4 --> |是| Inter3[插值计算<br/>到-76°]
    Phase4 --> |否| Asymp[渐近线<br/>θ→-90°]
    
    Linear --> Return[返回: H×10000, θ×100]
    Inter1 --> Return
    Inter2 --> Return
    Inter3 --> Return
    Asymp --> Return
    
    Return --> End([完成])
    
    style Start fill:#e1f5ff
    style Newton fill:#fff3e0
    style CalcH fill:#c8e6c9
```

---

## 9. 错误处理流程

```mermaid
flowchart TD
    Start([发生错误]) --> Type{错误类型?}
    
    Type --> |信号弱| Check1[ADC<10]
    Type --> |信号强| Check2[ADC>4000]
    Type --> |命令长| Check3[缓冲区满]
    Type --> |连接错| Check4[串口断开]
    
    Check1 --> Diag1[诊断步骤:<br/>1.检查DAC连接<br/>2.运行DEBUG<br/>3.检查VREF<br/>4.检查线路]
    Check2 --> Diag2[诊断步骤:<br/>1.检查信号源<br/>2.降低幅度<br/>3.检查ADC饱和]
    Check3 --> Diag3[诊断步骤:<br/>1.命令过长<br/>2.缓冲区复位]
    Check4 --> Diag4[诊断步骤:<br/>1.检查USB线<br/>2.重新连接<br/>3.检查串口号]
    
    Diag1 --> Output[输出详细提示]
    Diag2 --> Output
    Diag3 --> Output
    Diag4 --> Output
    
    Output --> Log[记录到日志]
    Log --> Recover{可恢复?}
    
    Recover --> |是| Continue[继续运行]
    Recover --> |否| Stop[停止测量]
    
    Continue --> End([返回主循环])
    Stop --> End
    
    style Start fill:#ffcdd2
    style Output fill:#fff3e0
    style Continue fill:#c8e6c9
```

---

## 10. 系统时序图

```mermaid
gantt
    title 系统运行时序（1秒内）
    dateFormat SSS
    axisFormat %L ms
    
    section TIMER2 (50kHz)
    DDS中断 :active, t1, 000, 20ms
    DDS中断 :active, t2, 020, 20ms
    DDS中断 :active, t3, 040, 20ms
    DDS中断 :active, t4, 060, 20ms
    DDS中断 :active, t5, 080, 20ms
    
    section TIMER3 (10kHz)
    ADC触发 :crit, a1, 000, 100ms
    ADC触发 :crit, a2, 100, 100ms
    ADC触发 :crit, a3, 200, 100ms
    ADC触发 :crit, a4, 300, 100ms
    
    section DMA传输
    数据传输 :done, d1, 000, 100ms
    数据传输 :done, d2, 100, 100ms
    数据传输 :done, d3, 200, 100ms
    
    section 主循环
    空闲等待 :active, m1, 000, 100ms
    处理命令 :m2, 100, 50ms
    空闲等待 :active, m3, 150, 150ms
```

---

**文档版本**: v1.0  
**更新日期**: 2025-10-18  
**适用项目**: GD32F103 伯德图分析仪






